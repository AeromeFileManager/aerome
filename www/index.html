<!--
  Copyright (c) 2023 Jesse Tuchsen
 
  This file is part of Aerome.
 
  Aerome is free software: you can redistribute it and/or modify it under the terms of the GNU
  General Public License as published by the Free Software Foundation, version 3 of the License.
 
  Aerome is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
  Public License for more details.
 
  You should have received a copy of the GNU General Public License along with Aerome. If not, see
  <https://www.gnu.org/licenses/>.
-->
<!doctype html>

<style>
    @keyframes open {
        0% { opacity: 0 }
        100% { opacity: 1 }
    }

    /* closing animation */
    @keyframes close {
        0% { opacity: 1 }
        100% { opacity: 0 }
    }

    details[open] summary~* {
        animation: open .5s
    }

    /* closing class */
    details.closing summary~* {
        animation: close .5s
    }

    html, body {
        background: transparent;
    }

    html {
        margin: 0;
        --primary-bg: rgba(26, 25, 25, 1);
        --primary-bg-semi-transparent: rgba(26, 25, 25, 0.7);
    }

    body {
        --window-drop-shadow-margin: 10px;
        --header-compressed-height: 20px;
        --header-large-height: 48px;

        height: 100%;
        overflow: hidden;
        margin: var(--window-drop-shadow-margin);
    }

    body > main {
        background: var(--primary-bg);
        color: antiquewhite;
        width: 100%;
        height: 100%;
        overflow: hidden;
        border-radius: 10px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        box-shadow: 2px 2px 10px black;
        display: flex;
        flex-direction: column;
    }

    header {
        position: fixed;
        left: var(--window-drop-shadow-margin);
        right: var(--window-drop-shadow-margin);
        display: grid;
        padding: 5px;
        grid-template-columns: 80px 48px 1fr 80px;
        grid-template-rows: var(--header-height);
        -webkit-user-select: none;
        user-select: none;
        transition: all 0.2s ease-in-out;
        border-top-right-radius: 10px;
        border-top-left-radius: 10px;

        --header-height: 48px;
    }

    header.compressed {
        --header-height: var(--header-compressed-height);
        background: var(--primary-bg-semi-transparent);
        /*
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
        */
    }

    header .menu {
        background-image: url("icon://open-menu-symbolic?size=32");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 20px;
        width: 48px;
        height: var(--header-height);
        transition: height 0.2s ease-in-out;
    }

    header .menu .content {
        display: flex;
        position: absolute;
        justify-content: center;
        top: 55px;
        width: 200px;
        height: 280px;
        background: white;
        border-radius: 10px;
        z-index: 2;
    }

    header .menu .content form {
        padding: 10px;
        margin: 10px;
        color: black;
    }

    header .menu .content form > :is(input, fieldset, label) {
        margin-bottom: 20px;
    }

    header .menu .content form fieldset {
        border: 0;
    }

    header .menu .content form fieldset input {
        appearance: none;
        width: 30px;
        height: 30px;
        background-repeat: no-repeat;
        background-position: center;
        background-size: 20px;
        transition: all 0.2s ease-out;
        border: 0.1px solid transparent;
        border-radius: 4px;
    }

    header .menu .content form fieldset input:checked {
        filter: brightness(0);
        transform: scale(1.1);
        border-color: black;
    }

    header .menu .content form fieldset input:nth-child(1) {
        background-image: url(icon://view-sort-descending-symbolic?size=32);
    }
    header .menu .content form fieldset input:nth-child(2) {
        background-image: url(icon://view-sort-ascending-symbolic?size=32);
    }

    header .menu .content form fieldset input:nth-child(3) {
        background-image: url(icon://stopwatch-symbolic?size=32);
    }

    header .menu .content form label {
        display: block;
    }

    header .menu .content h2 {
        font-size: 18px;
        margin: 0;
        margin-bottom: 6px;
        padding: 0;
    }

    header .menu .content:not(.showing) {
        display: none;
    }

    header .menu .tap-area {
        position: fixed;
        inset: 0;
        z-index: 1;
    }

    header .menu .content:not(.showing) ~ .tap-area {
        display: none;
    }

    header .controls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-right: 10px;
    }

    header .controls img {
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    header .folder-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        overflow: hidden;
    }

    header h1 {
        padding: 0 10px;
        margin: 0;
        font-size: 16px;
        text-align: center;
        transition: all 0.2s ease-in-out;
        line-height: 32px;
        height: 30px;
    }

    header.compressed h1 {
        font-size: 13px;
    }

    header button#back {
        position: fixed;
        left: calc(var(--window-drop-shadow-margin) + 10px);
        top: calc(var(--window-drop-shadow-margin) + 10px);
        height: 36px;
        width: 80px;
    }

    header.compressed button#back {
        opacity: 0;
    }

    h2 { font-size: 14px; }

    ul { padding: 0; margin: 10px; list-style-type: none; }

    .files-wrapper {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: calc(100vh - 38px);
        max-height: calc(100vh - 38px);
    }

    .spacer {
        min-height: 20px;
    }

    div#file-deep-look.error {
        content: '         Couldn\'t Open File';
        width: 200px;
        height: 200px;
        background: url(icon://error-symbolic?size=32);
        background-repeat: no-repeat;
        background-size: 150px;
        position: absolute;
        background-position-y: 40px;
        position: absolute;
        left: calc(50% - 45px);
        top: 120px;
    }

    ul#files.missing::after {
        content: '         Missing Directory';
        width: 200px;
        height: 200px;
        background: url(icon://image-missing-symbolic?size=32);
        background-repeat: no-repeat;
        background-size: 150px;
        position: absolute;
        background-position-y: 40px;
        position: absolute;
        left: calc(50% - 45px);
        top: 120px;
    }

    ul#files {
        --grid-size: calc(120px + 100px * var(--grid-scale, 0.35));

        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(var(--grid-size), 1fr));
        grid-gap: 30px;
        margin-bottom: var(--header-large-height);
        margin-top: var(--header-large-height);
    }

    ul#files > li {
        display: flex;
        flex-direction: column;
        max-height: calc(var(--grid-size) - 20px);
        padding-bottom: 4px;
        transition: filter 0.15s ease-in-out;
    }

    ul#files > li:hover {
        filter: brightness(117%);
    }

    ul#files > li > .image {
        min-height: calc(var(--grid-size) - 40px);
        max-height: calc(var(--grid-size) - 40px);
        object-fit: contain;
    }

    ul#files > li > span {
        text-align: center;
    }

    #action-wrapper {
        position: fixed;
        bottom: calc(4px + var(--window-drop-shadow-margin));
        left: var(--window-drop-shadow-margin);
        right: var(--window-drop-shadow-margin);
        height: 38px;
        opacity: 0.7;
        padding-left: 12px;
        -webkit-backdrop-filter: blur(8px);
        transition: height 0.25s ease-in-out, background 0.2s ease-in-out;
        color: black;
        background: transparent;
    }

    #action-wrapper.open {
        height: 220px;
        background: var(--primary-bg);
        bottom: 8px;
        border-top: 1px solid white;
    }

    #action-wrapper.open ~ #action-sibling {
        height: 220px;
    }

    #action-wrapper ~ input#action {
        height: 34px;
        position: fixed;
        bottom: calc(5px + var(--window-drop-shadow-margin));
        left: calc(2px + var(--window-drop-shadow-margin));
        right: calc(2px + var(--window-drop-shadow-margin));
        padding-left: 120px;
        padding-right: 120px;
        text-align: center;
        z-index: 1000;
        background:
            radial-gradient(circle,
                rgba(255,255,255,0.74) 0%,
                rgba(255,255,255,0.76) 25%,
                rgba(255,255,255,0.83) 50%,
                rgba(255,255,255,0.88) 75%,
                rgba(255,255,255,0.92) 100%),

            linear-gradient(0deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.25) 75%,
                rgba(255,255,255,0.6) 100%),

            linear-gradient(180deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.25) 75%,
                rgba(255,255,255,0.6) 100%);

        border: 0.1px solid rebeccapurple;
        border-radius: 4px;
        outline: none;
        -webkit-appearance: none;
        -webkit-backdrop-filter: blur(8px) saturate(500%);
    }

    #action-sibling {
        position: fixed;
        bottom: var(--window-drop-shadow-margin);
        left: var(--window-drop-shadow-margin);
        right: var(--window-drop-shadow-margin);
        height: 42px;
        background: transparent;
        transition: height 0.25s ease-in-out;
        color: black;
    }


    #action-wrapper ~ #action-sibling ul#actions,
    #action-wrapper ~ #action-sibling ul#conversation {
        z-index: 100;
        transition: margin 0.4s ease-out, color 0.4s ease-in;
        color: rgba(0,0,0,0);
    }

    #action-wrapper ~ #action-sibling .overflow-wrapper {
        display: block;
        width: calc(100vw - var(--window-drop-shadow-margin) * 2);
        height: 220px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 2px;
    }

    #action-wrapper.open.actions ~ #action-sibling ul#actions,
    #action-wrapper.open.conversation ~ #action-sibling ul#conversation {
        color: rgba(0,0,0,1);
    }

    #action-wrapper ~ #action-suggestions {
        position: fixed;
        bottom: calc(8px + var(--window-drop-shadow-margin));
        left: calc(6px + var(--window-drop-shadow-margin));
        height: 32px;
        -webkit-appearance: none;
        background: white;
        border-bottom-left-radius: 4px;
        border-top-left-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
        z-index: 1001;
    }

    #action-wrapper ~ #action-submit {
        position: fixed;
        bottom: calc(8px + var(--window-drop-shadow-margin));
        right: calc(6px + var(--window-drop-shadow-margin));
        height: 32px;
        -webkit-appearance: none;
        background: white;
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
        z-index: 1001;
    }

    #conversation {
        display: flex;
        flex-direction: column;
        padding-bottom: 30px;
    }

    #conversation li {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        max-width: 75%;
        background: white;
        border-radius: 10px;
        margin: 0;
        margin-bottom: 10px;
        line-height: 30px;
        padding: 0 10px;
        overflow-x: hidden;
    }

    #conversation li.ai {
        align-self: flex-end;
    }

    #conversation li.ai code pre {
        overflow-y: scroll;
    }

    #conversation li.ai code ~ button.evaluate {
        width: 100px;
        align-self: flex-end;
        padding: 10px;
        margin-bottom: 10px;
    }

    #conversation.locked li.ai {
        min-width: 310px;
    }

    #conversation.locked li.ai.lock p:after {
        overflow: hidden;
        display: inline-block;
        vertical-align: bottom;
        -webkit-animation: ellipsis steps(4,end) 900ms infinite;      
        animation: ellipsis steps(4,end) 900ms infinite;
        content: "\2026"; /* ascii code for the ellipsis character */
        width: 0px;
    }

    #action-wrapper:not(.open.conversation) ~ #action-sibling #conversation {
        display: none;
    }

    @keyframes ellipsis {
        to {
            width: 1.25em;    
        }
    }

    @-webkit-keyframes ellipsis {
        to {
            width: 1.25em;    
        }
    }

    input[type=range] {
        appearance: none;
        width: 100%;
        background: transparent;
        height: 2px;
        background: black;
    }

    button#close-actions {
        appearance: none;
        width: 48px;
        height: 48px;
        position: absolute;
        top: 10px;
        right: 10px;
        background: url(icon://go-down-symbolic?size=32);
        background-repeat: no-repeat;
        background-position: center;
        background-size: 20px;
        border: 0;
        cursor: pointer;
    }

</style>
<body>
    <main>
        <header id="header">
            <div></div>
            <button id="back">Back</button>

            <div class="menu"
                onclick="event.target.matches('.tap-area, .menu') && this.firstElementChild.classList.toggle('showing')">
                <div class="content">
                    <form>
                        <h2>Scale</h2>
                        <input class="grid-scale" type="range" min=0 max=1 value=0.25 step=0.01
                            oninput="future.settings.gridScale = this.value" />

                        <h2>Sort</h2>

                        <fieldset id="sort"
                            onchange="future.settings.sort = this.querySelector(':checked').value">
                            <input type="radio" name="sort" value="a-z" />
                            <input type="radio" name="sort" value="z-a" />
                            <input type="radio" name="sort" value="date" />
                        </fieldset>

                        <label>
                            <input id="sort_folders_first" type="checkbox" name="folders_first"
                                onchange="future.settings.sortFoldersFirst = this.checked" />
                            Folders first
                        </label>

                        <label>
                            <input id="sort_show_hidden" type="checkbox" name="show_hidden"
                                onchange="future.settings.sortShowHidden = this.checked" />
                            Show hidden
                        </label>
                    </form>
                </div>

                <div class="tap-area" aria-hidden=true></div>
            </div>

            <div class="folder-wrapper">
                <h1 id="folder" contenteditable></h1>
            </div>

            <div class="controls">
                <img
                    id="control-minimize"
                    src="icon://window-minimize-symbolic?size=32"
                    alt="minimize application" />

                <img
                    id="control-maximize"
                    src="icon://window-maximize-symbolic?size=32"
                    alt="maximize application" />

                <img
                    id="control-close"
                    src="icon://window-close-symbolic?size=32"
                    alt="close application" />
            </div>
        </header>

        <div class="files-wrapper">
            <ul id="files"></ul>
            <div id="file-deep-look"></div>
        </div>

        <div class="spacer" aria-hidden=true></div>

        <div id="action-wrapper">
        </div>

        <input type="text" id="action" />

        <button id="action-suggestions">Suggestions</button>
        <button id="action-submit">Conversation</button>

        <div id="action-sibling">
            <div class="overflow-wrapper">
                <ul id="actions">

                </ul>

                <ul id="conversation">
                </ul>
            </div>
            <button id="close-actions"></button>
        </div>
    </main>

    <script>
        window.future = {
            settings: {
                get sort() {
                    return localStorage.sort?.toLowerCase() ?? 'a-z';
                },
                set sort(sort) {
                    sort = sort.toLowerCase();
                    localStorage.sort = sort;

                    document
                        .querySelector(`header #sort [value="${sort}"]`)
                        .checked = true;

                    notifyOptionsUpdate();
                },
                get sortFoldersFirst() {
                    switch (localStorage.sortFoldersFirst) {
                        case undefined:
                        case 'true': return true;
                        default: return false;
                    }
                },
                set sortFoldersFirst(sort) {
                    document.querySelector('header #sort_folders_first').checked = ('' + sort) === 'true';
                    localStorage.sortFoldersFirst = sort;
                    notifyOptionsUpdate();
                },
                get sortShowHidden() {
                    switch (localStorage.sortShowHidden) {
                        case 'true': return true;
                        default: return false;
                    }
                },
                set sortShowHidden(sort) {
                    document.querySelector('header #sort_show_hidden').checked = ('' + sort) === 'true';
                    localStorage.sortShowHidden = sort;
                    notifyOptionsUpdate();
                },
                get gridScale() {
                    const scale = +localStorage.gridScale;
                    return Number.isNaN(scale) ? 0.25 : scale;
                },
                set gridScale(scale) {
                    localStorage.gridScale = scale;
                    document.querySelector('header .grid-scale').value = scale;
                    document.getElementById('files').style.setProperty('--grid-scale', scale);
                }
            }
        };

        let rpc = {
            invoke(arg) {
                window.ipc.postMessage(JSON.stringify(arg));
            }
        };

        document.getElementById('back').addEventListener('click', e => {
            rpc.invoke({ cmd: 'back', options: future.settings });
        });

        document.getElementById('action').addEventListener('keypress', e => {
            if (e.key !== 'Enter') return;

            const input = e.target.closest('input');
            if (!input) return;

            const message = input.value;

            addConversationItem('user', message);
        });

        document.getElementById('files').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
            rpc.invoke({ cmd: 'forward', to: li.textContent, options: future.settings });
        });

        document.getElementById('actions').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
        });

        document.getElementById('action-suggestions').addEventListener('click', e => {
            document.getElementById('action-wrapper').classList.add('open', 'actions');
            document.getElementById('action-wrapper').classList.remove('conversation');
        });

        document.getElementById('action-submit').addEventListener('click', e => {
            const message = document.getElementById('action').value;
            if (!message) return;

            addConversationItem('user', message);
        });

        window.setFileDeepLook = ({ name, path, openers }) => {
            // TODO: This is meant to have extended file attributes, large thumbnails,
            // and an "open with" view. Also it'll focus the model to operating on just
            // the one file. For now though, it serves as an error screen for a failure
            // to open a file when xdg-open can't find a proper application
            resetFolder(path);

            const isFileOpenError = !openers.length;
            if (isFileOpenError) {
                const el = document.getElementById('file-deep-look');
                el.innerHTML = '';
                el.classList.add('error');
            } else {
                el.classList.remove('error');
            }
        };

        let initialized = false;
        window.setFolder = ({ path, files }) => {
            const filesEl = document.getElementById('files');
            const folderEl = document.getElementById('folder');

            resetFolder(path);
            document.getElementById('file-deep-look').classList.remove('error');

            for (const file of files) {
                const li = document.createElement('li');
                const span = document.createElement('span');

                if (file.graphic) {
                    const graphic = document.createElement('img');
                    graphic.src = file.graphic;
                    graphic.className = 'image';
                    li.append(graphic);
                } else {
                    const dummy = document.createElement('div');
                    dummy.className = 'image';
                    li.append(dummy);
                }

                span.textContent = file.name;
                li.id = `file-${encodeFilenameToId(file.name)}`;
                li.append(span);

                filesEl.append(li);
            }

            if (!initialized) {
                initialized = true;
                rpc.invoke({ cmd: 'initialized' });
            }
        };

        window.updateThumbnail = ({ name, url }) => {
            const li = document.getElementById(`file-${encodeFilenameToId(name)}`);
            if (li) {
                li.querySelector('img').src = url;
            }
        };

        window.setMissingFolder = ({ path }) => {
            setFolder({ path, files: [] });
            document.getElementById('files').classList.add('missing');
        };

        window.setSuggestions = ({ path, actions }) => {
            document.getElementById('actions').innerHTML = '';

            for (const action of actions) {
                const li = document.createElement('li');
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                const p = document.createElement('p');

                summary.textContent = action.title;
                p.textContent = action.description;

                details.append(summary);
                details.append(p);

                li.append(details);

                details.addEventListener('click', detailsAnimationOpen.bind(details, details));
                details.addEventListener('animationend', detailsAnimationEnd.bind(details, details));
                document.getElementById('actions').append(li);
            }
        };

        window.addConversationItem = (from, message, codeblock) => {
            const conversation = document.getElementById('conversation');

            if (from === 'user' && conversation.classList.contains('locked')) {
                return;
            }

            if (from === 'user') {
                rpc.invoke({ cmd: 'communicate', message });
            }

            if (from === 'ai' && conversation.classList.contains('locked')) {
                conversation.classList.remove('locked');
                conversation.querySelector('li.lock').remove();
            }

            const li = document.createElement('li');
            const p = document.createElement('p');

            p.textContent = message;
            li.className = from;
            li.append(p);

            if (codeblock) {
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                const evaluateButton = document.createElement('button');
                const evaluateCode = () => {
                    rpc.invoke({ cmd: 'evaluate', script: codeblock, options: future.settings });
                };

                code.append(pre);
                pre.textContent = codeblock;

                evaluateButton.className = 'evaluate';
                evaluateButton.textContent = 'Evaluate';
                evaluateButton.addEventListener('click', evaluateCode, { once: true });

                li.append(code);
                li.append(evaluateButton);
            }

            conversation.append(li);
            document.getElementById('action-wrapper').classList.add('open', 'conversation');
            document.getElementById('action-wrapper').classList.remove('actions');

            if (from === 'user') {
                document.getElementById('action').value = '';

                const item = addConversationItem('ai', 'Hold on a second while I process this');
                item.classList.add('lock');
                conversation.classList.add('locked');
            }

            li.scrollIntoView({ behavior: 'smooth' });
            return li;
        };

        window.closeActionsBox = () => {
            document.getElementById('action-wrapper').classList.remove(
                'open',
                'actions',
                'conversation'
            );
        };

        function resetFolder(path) {
            const filesEl = document.getElementById('files');
            const folderEl = document.getElementById('folder');

            filesEl.classList.remove('missing');

            filesEl.innerHTML = '';
            folderEl.textContent = path;

            folderEl.blur();
            filesEl.focus();
        }

        function detailsAnimationOpen(details, e) {
            if (details.hasAttribute("open")) {
                e.preventDefault();
                details.classList.add("closing");
            }
        }

        function detailsAnimationEnd(details, e) {
            if (e.animationName === "close") {
                details.removeAttribute("open");
                details.classList.remove("closing");
            }
        }

        document.querySelector('.files-wrapper').addEventListener('scroll', e => {
            const offset = e.target.scrollTop;

            if (offset > 30) {
                header.classList.add('compressed');
                //header.style.setProperty('--header-height', '--header-height-comp');
            } else {
                header.classList.remove('compressed');
                //header.style.setProperty('--header-height', '20px');
            }
        });

        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('folder-wrapper') && e.buttons === 1) {
                rpc.invoke({ cmd: 'window', window: 'drag' });
                e.preventDefault();
                //e.detail === 2
                    //? window.ipc.postMessage()
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('folder-wrapper')) {
                window.ipc.postMessage('drag_window');
            }
        });

        document.getElementById('folder').addEventListener('keypress', e => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            rpc.invoke({ cmd: 'jump', to: e.target.textContent, options: future.settings });
        });

        document.getElementById('close-actions').addEventListener('click', e => {
            closeActionsBox();
        });

        document.addEventListener('keydown', e => {
            switch (event.key) {
                case 'l': {
                    if (event.ctrlKey) {
                        document.getElementById('folder').focus();
                        document.execCommand('selectAll', false, null);
                    }
                    break;
                }
                case 'ArrowLeft': {
                    if (event.altKey) {
                        rpc.invoke({ cmd: 'back', options: future.settings });
                    }
                    break;
                }
                case 'Escape': {
                    const action = e.target.closest('input#action');
                    if (action && action === document.activeElement) {
                        closeActionsBox();
                    }
                    break;
                }
                default: {
                    if (!e.target.closest('input#action') && !e.target.closest('h1#folder')) {
                        const action = document.getElementById('action');
                        action.focus();
                    }
                }
            }
        });

        document.getElementById('action-submit').addEventListener('click', e => {
            document.getElementById('action-wrapper').classList.remove('actions');
            document.getElementById('action-wrapper').classList.add('open', 'conversations');
        });

        document.getElementById('control-minimize').addEventListener('click', e => {
            rpc.invoke({ cmd: 'window', window: 'minimize' });
        });

        document.getElementById('control-maximize').addEventListener('click', e => {
            rpc.invoke({ cmd: 'window', window: 'maximize' });
        });

        document.getElementById('control-close').addEventListener('click', e => {
            rpc.invoke({ cmd: 'window', window: 'close' });
        });

        const debounce = (delay, cb) => {
            let id;
            return (...args) => {
                if (id) clearTimeout(id);
                id = setTimeout(() => {
                    cb(...args);
                    id = null;
                }, delay);
            };
        };

        const notifyOptionsUpdate = debounce(250, () => {
            rpc.invoke({ cmd: 'options', options: future.settings });
        });

        function encodeFilenameToId(name) {
            return MD5(unescape(encodeURIComponent(name)));
        }

        Object.assign(future.settings, future.settings);
        function MD5(d){var r = M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}
    </script>
</body>
