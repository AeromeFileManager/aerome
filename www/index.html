<!--
  Copyright (c) 2023 Jesse Tuchsen
 
  This file is part of Aerome.
 
  Aerome is free software: you can redistribute it and/or modify it under the terms of the GNU
  General Public License as published by the Free Software Foundation, version 3 of the License.
 
  Aerome is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
  Public License for more details.
 
  You should have received a copy of the GNU General Public License along with Aerome. If not, see
  <https://www.gnu.org/licenses/>.
-->
<!doctype html>

<style>
    @keyframes open {
        0% { opacity: 0 }
        100% { opacity: 1 }
    }

    /* closing animation */
    @keyframes close {
        0% { opacity: 1 }
        100% { opacity: 0 }
    }

    details[open] summary~* {
        animation: open .5s
    }

    /* closing class */
    details.closing summary~* {
        animation: close .5s
    }

    html, body {
        background: #1a1919;
        color: antiquewhite;
    }
    html, body {
        background: #1a1919;
        color: antiquewhite; 
    }
    body {
        padding-bottom: 40px;
    }

    header {
        display: grid;
        padding: 5px;
        grid-template-columns: 80px 1fr;
        -webkit-user-select: none;
        user-select: none;
    }
    header h1 {
        
    }

    h1 { font-size: 18px; }

    h2 { font-size: 14px; }

    #files li {
        padding-bottom: 4px;
    }

    ul { padding: 0; margin: 10px; list-style-type: none; }

    ul#files {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        grid-gap: 15px;
    }
    ul#files > li {
        display: flex;
        flex-direction: column;
        max-height: 180px;
    }

    ul#files > li > .image {
        min-height: 160px;
        max-height: 160px;
    }

    #action-wrapper {
        position: fixed;
        bottom: 0px;
        left: 0px;
        right: 0px;
        height: 42px;
        opacity: 0.7;
        padding-left: 12px;
        -webkit-backdrop-filter: blur(8px);
        transition: height 0.25s ease-in-out, background 0.2s ease-in-out;
        color: black;
        background: transparent;
    }

    #action-wrapper.open {
        height: 200px;
        background: rgba(240,240,240, 0.9);
    }

    #action-wrapper input#action {
        height: 32px;
        position: absolute;
        bottom: 5px;
        left: 5px;
        right: 5px;
        text-align: center;
    }

    #action-wrapper ul#actions {
        position: absolute;
        top: 32px;
        left: 0;
        right: 0;
        z-index: -1;
        transition: margin 0.4s ease-out, color 0.4s ease-in;
        color: rgba(0,0,0,0);
    }

    #action-wrapper.open ul#actions {
        margin-top: -32px;
        color: rgba(0,0,0,1);
    }

    #action-wrapper ~ #action-suggestions {
        position: fixed;
        bottom: 8px;
        left: 8px;
        height: 32px;
        -webkit-appearance: none;
        background: rgb(247, 247, 247);
        border-bottom-left-radius: 4px;
        border-top-left-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
    }

    #action-wrapper ~ #action-submit {
        position: fixed;
        bottom: 8px;
        right: 8px;
        height: 32px;
        -webkit-appearance: none;
        background: rgb(247, 247, 247);
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
    }
</style>
<body>
    <header>
        <button id="back">Back</button>
        <h1 id="folder" class="titlebar"></h1>
    </header>

    <ul id="files">

    </ul>

    <div id="action-wrapper">
        <input type="text" id="action" />

        <ul id="actions">

        </ul>
    </div>

    <button
        id="action-suggestions"
        onclick="this.previousElementSibling.classList.toggle('open')">Suggestions</button>

    <button id="action-submit">Conversation</button>

    <script>
        let rpc = {
            invoke(arg) {
                window.ipc.postMessage(JSON.stringify(arg));
            }
        };

        document.getElementById('back').addEventListener('click', e => {
            rpc.invoke({ cmd: "back" });
        });

        document.getElementById('action').addEventListener('keypress', e => {
            if (e.key !== 'Enter') return;

            const input = e.target.closest('input');
            if (!input) return;

            rpc.invoke({
                cmd: 'communicate',
                message: input.value
            })
        })

        document.getElementById('files').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
            rpc.invoke({ cmd: 'forward', to: li.textContent });
        });

        document.getElementById('actions').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
        });

        window.onload = () => {
            rpc.invoke({ cmd : 'init' });
        };

        window.setFolder = ({ path, files }) => {
            document.getElementById('files').innerHTML = '';
            document.getElementById('folder').textContent = path;

            for (const file of files) {
                const li = document.createElement('li');
                const span = document.createElement('span');

                if (file.thumbnail) {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = 'thumbnail://' + file.thumbnail;
                    thumbnail.className = 'image';
                    li.append(thumbnail);
                } else {
                    const dummy = document.createElement('div');
                    dummy.className = 'image';
                    li.append(dummy);
                }

                span.textContent = file.name;
                li.append(span);

                document.getElementById('files').append(li);
            }
        };

        window.setDescription = ({ path, actions }) => {
            document.getElementById('actions').innerHTML = '';

            for (const action of actions) {
                const li = document.createElement('li');
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                const p = document.createElement('p');

                summary.textContent = action.title;
                p.textContent = action.description;

                details.append(summary);
                details.append(p);

                li.append(details);

                details.addEventListener("click", detailsAnimationOpen.bind(details, details));
                details.addEventListener("animationend", detailsAnimationEnd.bind(details, details));
                document.getElementById('actions').append(li);
            }
        };

        function relayMessage(cmd) {
            if (window.external !== undefined) {
                return window.external.invoke(cmd);
            } else if (window.webkit.messageHandlers.external !== undefined) {
                return window.webkit.messageHandlers.external.postMessage(cmd);
            }
            throw new Error('Failed to locate webkit external handler')
        }

        function detailsAnimationOpen(details, e) {
            if (details.hasAttribute("open")) {
                e.preventDefault();
                details.classList.add("closing");
            }
        }

        function detailsAnimationEnd(details, e) {
            if (e.animationName === "close") {
                details.removeAttribute("open");
                details.classList.remove("closing");
            }
        }
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('titlebar') && e.buttons === 1) {
                rpc.invoke({ cmd: 'window', window: 'drag' });
                //e.detail === 2
                    //? window.ipc.postMessage()
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('.titlebar')) {
                window.ipc.postMessage('drag_window');
            }
        });
    </script>
</body>
