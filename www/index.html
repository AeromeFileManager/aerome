<!--
  Copyright (c) 2023 Jesse Tuchsen
 
  This file is part of Aerome.
 
  Aerome is free software: you can redistribute it and/or modify it under the terms of the GNU
  General Public License as published by the Free Software Foundation, version 3 of the License.
 
  Aerome is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
  Public License for more details.
 
  You should have received a copy of the GNU General Public License along with Aerome. If not, see
  <https://www.gnu.org/licenses/>.
-->
<!doctype html>

<!--These icons are preloaded because otherwise the hamburger menu hangs a bit on 1st open-->
<!--
<link rel="preload" href="icon://view-sort-descending-symbolic?size=32" as="image">
<link rel="preload" href="icon://view-sort-ascending-symbolic?size=32" as="image">
<link rel="preload" href="icon://stopwatch-symbolic?size=32" as="image">
-->

<style>
    @keyframes open {
        0% { opacity: 0 }
        100% { opacity: 1 }
    }

    /* closing animation */
    @keyframes close {
        0% { opacity: 1 }
        100% { opacity: 0 }
    }

    details[open] summary~* {
        animation: open .5s
    }

    /* closing class */
    details.closing summary~* {
        animation: close .5s
    }

    html, body {
        background: #1a1919;
        color: antiquewhite;
    }

    body {
        padding-bottom: 40px;
    }

    header {
        display: grid;
        padding: 5px;
        grid-template-columns: 80px 1fr 1fr;
        grid-template-rows: 46px;
        -webkit-user-select: none;
        user-select: none;
    }

    header .menu {
        background-image: url("icon://open-menu-symbolic?size=32");
        background-repeat: no-repeat;
        background-position: center;
        width: 42px;
        height: 42px;
    }

    header .menu .content {
        display: flex;
        position: absolute;
        justify-content: center;
        top: 55px;
        width: 200px;
        height: 280px;
        background: white;
        border-radius: 10px;
        z-index: 2;
    }

    header .menu .content form {
        padding: 10px;
        margin: 10px;
        color: black;
    }

    header .menu .content form > :is(input, fieldset, label) {
        margin-bottom: 20px;
    }

    header .menu .content form fieldset {
        border: 0;
    }

    header .menu .content form fieldset input {
        appearance: none;
        width: 30px;
        height: 30px;
        background-repeat: no-repeat;
        background-position: center;
        transition: all 0.2s ease-out;
        border: 0.1px solid transparent;
        border-radius: 4px;
    }

    header .menu .content form fieldset input:checked {
        filter: brightness(0);
        transform: scale(1.1);
        border-color: black;
    }

    header .menu .content form fieldset input:nth-child(1) {
        background-image: url(icon://view-sort-descending-symbolic?size=32);
    }
    header .menu .content form fieldset input:nth-child(2) {
        background-image: url(icon://view-sort-ascending-symbolic?size=32);
    }

    header .menu .content form fieldset input:nth-child(3) {
        background-image: url(icon://stopwatch-symbolic?size=32);
    }

    header .menu .content form label {
        display: block;
    }

    header .menu .content h2 {
        font-size: 18px;
        margin: 0;
        margin-bottom: 6px;
        padding: 0;
    }

    header .menu .content:not(.showing) {
        display: none;
    }

    header .menu .tap-area {
        position: fixed;
        inset: 0;
        z-index: 1;
    }

    header .menu .content:not(.showing) ~ .tap-area {
        display: none;
    }

    h1 { font-size: 18px; }
    h2 { font-size: 14px; }

    #files li {
        padding-bottom: 4px;
    }

    ul { padding: 0; margin: 10px; list-style-type: none; }

    ul#files {
        --grid-size: calc(120px + 100px * var(--grid-scale, 0.35));

        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(var(--grid-size), 1fr));
        grid-gap: 30px;
    }

    ul#files > li {
        display: flex;
        flex-direction: column;
        max-height: calc(var(--grid-size) - 20px);
    }

    ul#files > li > .image {
        min-height: calc(var(--grid-size) - 40px);
        max-height: calc(var(--grid-size) - 40px);
        object-fit: contain;
    }

    ul#files > li > span {
        text-align: center;
    }

    #action-wrapper {
        position: fixed;
        bottom: 0px;
        left: 0px;
        right: 0px;
        height: 42px;
        opacity: 0.7;
        padding-left: 12px;
        -webkit-backdrop-filter: blur(8px);
        transition: height 0.25s ease-in-out, background 0.2s ease-in-out;
        color: black;
        background: transparent;
    }

    #action-sibling {
        position: fixed;
        bottom: 0px;
        left: 0px;
        right: 0px;
        height: 42px;
        background: transparent;
        transition: height 0.25s ease-in-out;
        color: black;
        /*
        pointer-events: none;
        */
    }

    #action-wrapper.open {
        height: 200px;
        background: rgba(240,240,240, 0.9);
    }

    #action-wrapper.open ~ #action-sibling {
        height: 200px;
    }

    #action-wrapper.open ~ #action-sibling {
    }

    /*
    #action-sibling {
        z-index: 1;
    }
    */

    #action-wrapper input#dummy-action {
        height: 32px;
        position: absolute;
        bottom: 5px;
        left: 5px;
        right: 5px;
        text-align: center;
    }

    #action-wrapper ~ input#action {
        height: 34px;
        position: fixed;
        bottom: 5px;
        left: 120px;
        right: 120px;
        text-align: center;
        z-index: 1000;
        background: transparent;
        border: none;
        outline: none;
        -webkit-appearance: none;
    }


    #action-wrapper ~ #action-sibling ul#actions,
    #action-wrapper ~ #action-sibling ul#conversation {
        z-index: 100;
        transition: margin 0.4s ease-out, color 0.4s ease-in;
        color: rgba(0,0,0,0);
    }

    #action-wrapper ~ #action-sibling .overflow-wrapper {
        display: block;
        width: 100vw;
        height: 150px;
        overflow-y: auto;
        z-index: 1000;
    }

    #action-wrapper.open.actions ~ #action-sibling ul#actions,
    #action-wrapper.open.conversation ~ #action-sibling ul#conversation {
        /*
        margin-top: -32px;
        */
        color: rgba(0,0,0,1);
    }

    #action-wrapper ~ #action-suggestions {
        position: fixed;
        bottom: 8px;
        left: 8px;
        height: 32px;
        -webkit-appearance: none;
        background: rgb(247, 247, 247);
        border-bottom-left-radius: 4px;
        border-top-left-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
        z-index: 1001;
    }

    #action-wrapper ~ #action-submit {
        position: fixed;
        bottom: 8px;
        right: 8px;
        height: 32px;
        -webkit-appearance: none;
        background: rgb(247, 247, 247);
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
        z-index: 1001;
    }

    #conversation {
        display: flex;
        flex-direction: column;
    }

    #conversation li {
        margin-bottom: 10px;
        max-width: 420px;
        background: white;
        border-radius: 10px;
        margin: 0;
        line-height: 30px;
        padding: 0 10px;
    }

    #conversation li.ai {
        align-self: flex-end;
    }

    #conversation.locked li.ai {
        min-width: 310px;
    }

    #conversation.locked li.ai.lock p:after {
        overflow: hidden;
        display: inline-block;
        vertical-align: bottom;
        -webkit-animation: ellipsis steps(4,end) 900ms infinite;      
        animation: ellipsis steps(4,end) 900ms infinite;
        content: "\2026"; /* ascii code for the ellipsis character */
        width: 0px;
    }

    @keyframes ellipsis {
        to {
            width: 1.25em;    
        }
    }

    @-webkit-keyframes ellipsis {
        to {
            width: 1.25em;    
        }
    }

    input[type=range] {
        appearance: none;
        width: 100%;
        background: transparent;
        height: 2px;
        background: black;
    }

</style>
<body>
    <header>
        <button id="back">Back</button>
        <h1 id="folder" class="titlebar"></h1>
        <div>
            <div class="menu"
                onclick="event.target.matches('.tap-area, .menu') && this.firstElementChild.classList.toggle('showing')">
                <div class="content">
                    <form>
                        <h2>Scale</h2>
                        <input class="grid-scale" type="range" min=0 max=1 value=0.4 step=0.01
                            oninput="future.settings.gridScale = this.value" />

                        <h2>Sort</h2>

                        <fieldset id="sort"
                            onchange="future.settings.sort = this.querySelector(':checked').value">
                            <input type="radio" name="sort" value="a-z" />
                            <input type="radio" name="sort" value="z-a" />
                            <input type="radio" name="sort" value="date" />
                        </fieldset>

                        <label>
                            <input id="sort_folders_first" type="checkbox" name="folders_first"
                                onchange="future.settings.sortFoldersFirst = this.checked" />
                            Folders first
                        </label>

                        <label>
                            <input id="sort_show_hidden" type="checkbox" name="show_hidden"
                                onchange="future.settings.sortShowHidden = this.checked" />
                            Show hidden
                        </label>
                    </form>
                </div>

                <div class="tap-area" aria-hidden=true></div>
            </div>
        </div>
    </header>

    <ul id="files">

    </ul>

    <div id="action-wrapper">
        <input type="text" id="dummy-action" />
    </div>

    <input type="text" id="action" />

    <button id="action-suggestions">Suggestions</button>
    <button id="action-submit">Conversation</button>

    <div id="action-sibling">
        <div class="overflow-wrapper">
            <ul id="actions">

            </ul>

            <ul id="conversation">
                
            </ul>
        </div>
    </div>

    <script>
        window.future = {
            settings: {
                get sort() {
                    return localStorage.sort.toLowerCase();
                },
                set sort(sort) {
                    sort = sort.toLowerCase();
                    localStorage.sort = sort;

                    document
                        .querySelector(`header #sort [value="${sort}"]`)
                        .checked = true;

                    notifyOptionsUpdate();
                },
                get sortFoldersFirst() {
                    return localStorage.sortFoldersFirst === 'true'
                },
                set sortFoldersFirst(sort) {
                    document.querySelector('header #sort_folders_first').checked = ('' + sort) === 'true';
                    localStorage.sortFoldersFirst = sort;
                    notifyOptionsUpdate();
                },
                get sortShowHidden() {
                    return localStorage.sortShowHidden === 'true'
                },
                set sortShowHidden(sort) {
                    document.querySelector('header #sort_show_hidden').checked = ('' + sort) === 'true';
                    localStorage.sortShowHidden = sort;
                    notifyOptionsUpdate();
                },
                get gridScale() {
                    return +localStorage.gridScale;
                },
                set gridScale(scale) {
                    localStorage.gridScale = scale;
                    document.querySelector('header .grid-scale').value = scale;
                    document.getElementById('files').style.setProperty('--grid-scale', scale);
                    console.log('f');
                }
            }
        };

        let rpc = {
            invoke(arg) {
                window.ipc.postMessage(JSON.stringify(arg));
            }
        };

        document.getElementById('back').addEventListener('click', e => {
            rpc.invoke({ cmd: 'back', options: future.settings });
        });

        document.getElementById('action').addEventListener('keypress', e => {
            if (e.key !== 'Enter') return;

            const input = e.target.closest('input');
            if (!input) return;

            const message = input.value;

            addConversationItem('user', message);
        });

        document.getElementById('files').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
            rpc.invoke({ cmd: 'forward', to: li.textContent, options: future.settings });
        });

        document.getElementById('actions').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
        });

        document.getElementById('action-suggestions').addEventListener('click', e => {
            document.getElementById('action-wrapper').classList.add('open', 'actions');
            document.getElementById('action-wrapper').classList.remove('conversation');
        });

        document.getElementById('action-submit').addEventListener('click', e => {
            const message = document.getElementById('action').value;
            if (!message) return;

            addConversationItem('user', message);
        });

        window.setFolder = ({ path, files }) => {
            document.getElementById('files').innerHTML = '';
            document.getElementById('folder').textContent = path;

            for (const file of files) {
                const li = document.createElement('li');
                const span = document.createElement('span');

                if (file.graphic) {
                    const graphic = document.createElement('img');
                    graphic.src = file.graphic;
                    graphic.className = 'image';
                    li.append(graphic);
                } else {
                    const dummy = document.createElement('div');
                    dummy.className = 'image';
                    li.append(dummy);
                }

                span.textContent = file.name;
                li.append(span);

                document.getElementById('files').append(li);
            }
        };

        window.setSuggestions = ({ path, actions }) => {
            document.getElementById('actions').innerHTML = '';

            for (const action of actions) {
                const li = document.createElement('li');
                const details = document.createElement('details');
                const summary = document.createElement('summary');
                const p = document.createElement('p');

                summary.textContent = action.title;
                p.textContent = action.description;

                details.append(summary);
                details.append(p);

                li.append(details);

                details.addEventListener('click', detailsAnimationOpen.bind(details, details));
                details.addEventListener('animationend', detailsAnimationEnd.bind(details, details));
                document.getElementById('actions').append(li);
            }
        };

        window.addConversationItem = (from, message, codeblock) => {
            const conversation = document.getElementById('conversation');

            if (from === 'user' && conversation.classList.contains('locked')) {
                return;
            }

            if (from === 'user') {
                rpc.invoke({ cmd: 'communicate', message });
            }

            if (from === 'ai' && conversation.classList.contains('locked')) {
                conversation.classList.remove('locked');
                conversation.querySelector('li.lock').remove();
            }

            const li = document.createElement('li');
            const p = document.createElement('p');

            p.textContent = message;
            li.className = from;
            li.append(p);

            if (codeblock) {
                const pre = document.createElement('pre');
                const code = document.createElement('code');

                code.append(pre);
                pre.textContent = codeblock;
                li.append(code);
            }

            conversation.append(li);
            document.getElementById('action-wrapper').classList.add('open', 'conversation');
            document.getElementById('action-wrapper').classList.remove('actions');

            if (from === 'user') {
                document.getElementById('action').value = '';

                const item = addConversationItem('ai', 'Hold on a second while I process this');
                item.classList.add('lock');
                conversation.classList.add('locked');
            }

            return li;
        };

        function detailsAnimationOpen(details, e) {
            if (details.hasAttribute("open")) {
                e.preventDefault();
                details.classList.add("closing");
            }
        }

        function detailsAnimationEnd(details, e) {
            if (e.animationName === "close") {
                details.removeAttribute("open");
                details.classList.remove("closing");
            }
        }

        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('titlebar') && e.buttons === 1) {
                rpc.invoke({ cmd: 'window', window: 'drag' });
                //e.detail === 2
                    //? window.ipc.postMessage()
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('.titlebar')) {
                window.ipc.postMessage('drag_window');
            }
        });

        const debounce = (delay, cb) => {
            let id;
            return (...args) => {
                if (id) clearTimeout(id);
                id = setTimeout(() => {
                    cb(...args);
                    id = null;
                }, delay);
            };
        };

        const notifyOptionsUpdate = debounce(250, () => {
            rpc.invoke({ cmd: 'options', options: future.settings });
        });

        Object.assign(future.settings, future.settings);
    </script>
</body>
