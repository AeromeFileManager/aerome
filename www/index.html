<!--
  Copyright (c) 2023 Jesse Tuchsen
 
  This file is part of Aerome.
 
  Aerome is free software: you can redistribute it and/or modify it under the terms of the GNU
  General Public License as published by the Free Software Foundation, version 3 of the License.
 
  Aerome is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even
  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
  Public License for more details.
 
  You should have received a copy of the GNU General Public License along with Aerome. If not, see
  <https://www.gnu.org/licenses/>.
-->
<!doctype html>

<base target="_blank" />
<style>
    * {
        -webkit-user-select: none;
        user-select: none;
        cursor: default;
    }

    input[type="text"], [contenteditable] {
        cursor: text;
    }

    @keyframes open {
        0% { opacity: 0 }
        100% { opacity: 1 }
    }

    /* closing animation */
    @keyframes close {
        0% { opacity: 1 }
        100% { opacity: 0 }
    }

    details[open] summary~* {
        animation: open .5s
    }

    /* closing class */
    details.closing summary~* {
        animation: close .5s
    }

    html, body {
        background: transparent;
    }

    html {
        margin: 0;

        --color-dim-gray: rgba(119, 109, 101, 1);
        --color-dim-gray-semi-transparent: rgba(119, 109, 101, 0.7);

        --color-antique-white: rgba(254, 240, 221, 1);
        --color-antique-white-semi-transparent: rgba(254, 240, 221, 0.7);

        --color-raisin-black: rgba(42, 39, 39, 1);
        --color-raisin-black-semi-transparent: rgba(42, 39, 39, 0.7);

        --color-night: rgba(19, 19, 19, 1);
        --color-night-semi-transparent: rgba(19, 19, 19, 0.7);

        --color-chamoisee: rgba(164, 118, 73, 1);
        --color-chamoisee-semi-transparent: rgba(164, 118, 73, 0.7);

        --color-thistle: rgb(236, 201, 225);
        --color-thistle-semi-transparent: rgba(236, 201, 225, 0.7);

        --color-offwhite: rgba(250, 250, 250, 1);
        --color-offwhite-semi-transparent: rgba(250, 250, 250, 0.7);

        --color-rum-red: rgba(237, 95, 116, 1);
        --color-rum-red-semi-transparent: rgba(237, 95, 116, 0.7);

        --primary-bg: var(--color-raisin-black);
        --primary-bg-semi-transparent: var(--color-raisin-black-semi-transparent);

        --primary-fg: var(--color-antique-white);
        --primary-fg-semi-transparent: var(--color-antique-white-semi-transparent);

        --secondary-bg: var(--color-offwhite);
        --secondary-bg-semi-transparent: var(--color-offwhite-semi-transparent);

        --secondary-fg: var(--color-night);
        --secondary-fg-semi-transparent: var(--color-night-semi-transparent);

        --secondary-pop: var(--color-rum-red);
        --secondary-pop-semi-transparent: var(--color-rum-red-semi-transparent);
    }

    body {
        --window-drop-shadow-margin: 10px;
        --header-compressed-height: 20px;
        --header-large-height: 48px;

        height: 100%;
        overflow: hidden;
        margin: var(--window-drop-shadow-margin);
    }

    body > main {
        background: var(--primary-bg);
        color: var(--primary-fg);
        width: 100%;
        height: 100%;
        overflow: hidden;
        border-radius: 10px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        box-shadow: 2px 2px 10px black;
        display: flex;
        flex-direction: column;
        transition: filter 0.5s ease-in-out;
    }

    body > main > :is(.files-wrapper, .action-wrapper, #action-suggestions, #action-submit, #action-sibling, #action),
    body > main > header > :is(#back, .menu, .folder-wrapper) {
        transition: filter 0.5s ease-in-out;
    }

    body > main.inert > :is(.files-wrapper, .action-wrapper, #action-suggestions, #action-submit, #action-sibling, #action),
    body > main.inert > header > :is(#back, .menu, .folder-wrapper) {

      filter: grayscale(1) blur(4px);
    }

    header {
        position: fixed;
        left: var(--window-drop-shadow-margin);
        right: var(--window-drop-shadow-margin);
        display: grid;
        padding: 5px;
        grid-template-columns: 80px 48px 1fr 80px;
        grid-template-rows: var(--header-height);
        -webkit-user-select: none;
        user-select: none;
        transition: all 0.2s ease-in-out;
        border-top-right-radius: 10px;
        border-top-left-radius: 10px;
        z-index: 1;

        --header-height: 48px;
    }

    header.compressed {
        --header-height: var(--header-compressed-height);
        background: var(--primary-bg-semi-transparent);
        /*
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
        */
    }

    header .menu {
        background-image: url("icon://open-menu-symbolic?size=32");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 20px;
        width: 48px;
        height: var(--header-height);
        transition: height 0.2s ease-in-out;
    }

    header .menu .content {
        display: flex;
        position: absolute;
        justify-content: center;
        top: 55px;
        width: 200px;
        background: var(--color-offwhite);
        border-radius: 10px;
        z-index: 2;
    }

    header .menu .content form {
        width: 100%;
        margin: 10px;
        padding-top: 10px;
        color: var(--secondary-fg);
    }

    header .menu .content button {
        appearance: none;
        width: 100%;
        height: 40px;
        background: var(--secondary-bg);
        border: 0.1px solid var(--secondary-fg);
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.3s ease-in-out;
    }

    header .menu .content button:hover {
        border-color: var(--secondary-pop);
        color: var(--secondary-pop);
    }

    header .menu .content form > :is(input, label) {
        margin-bottom: 20px;
    }

    header .menu .content form fieldset {
        display: flex;
        justify-content: space-around;
        border: 0;
        margin-bottom: 10px;
    }

    header .menu .content form fieldset input {
        appearance: none;
        width: 30px;
        height: 30px;
        background-repeat: no-repeat;
        background-position: center;
        background-size: 20px;
        transition: all 0.2s ease-out;
        border: 0.1px solid transparent;
        border-radius: 4px;
    }

    header .menu .content form fieldset input:checked {
        filter: brightness(0);
        transform: scale(1.1);
        border-color: var(--secondary-fg);
    }

    header .menu .content form fieldset input:nth-child(1) {
        background-image: url(icon://view-sort-descending-symbolic?size=32);
    }
    header .menu .content form fieldset input:nth-child(2) {
        background-image: url(icon://view-sort-ascending-symbolic?size=32);
    }

    header .menu .content form fieldset input:nth-child(3) {
        background-image: url(icon://stopwatch-symbolic?size=32);
    }

    header .menu .content form label {
        display: block;
    }

    header .menu .content h2 {
        font-size: 18px;
        margin: 0;
        margin-bottom: 6px;
        padding: 0;
    }

    header .menu .content:not(.showing) {
        display: none;
    }

    header .menu .tap-area {
        position: fixed;
        inset: 0;
        z-index: 1;
    }

    header .menu .content:not(.showing) ~ .tap-area {
        display: none;
    }

    header .controls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-right: 10px;
    }

    header .controls img {
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    header .folder-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        overflow: hidden;
    }

    header h1 {
        padding: 0 10px;
        margin: 0;
        font-size: 16px;
        text-align: center;
        transition: all 0.2s ease-in-out;
        line-height: 32px;
        height: 30px;
    }

    header.compressed h1 {
        font-size: 13px;
    }

    header button#back {
        position: fixed;
        left: calc(var(--window-drop-shadow-margin) + 10px);
        top: calc(var(--window-drop-shadow-margin) + 10px);
        height: 36px;
        width: 80px;
        transition: background 0.3s ease-in-out, height 0.2s ease-in-out, top 0.2s ease-in-out;
    }

    header.compressed button#back {
        background: transparent;
        border: 0.1px solid pink;
        color: var(--color-offwhite);
        height: 18px;
        font-size: 12px;
        top: calc(var(--window-drop-shadow-margin) + 6px)
    }

    h2 { font-size: 14px; }

    ul { padding: 0; margin: 10px; list-style-type: none; }

    .files-wrapper {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: calc(100vh - 38px);
        max-height: calc(100vh - 38px);
        position: relative;
    }

    .spacer {
        min-height: 20px;
    }

    div#file-deep-look.error {
        content: '         Couldn\'t Open File';
        width: 200px;
        height: 200px;
        background: url(icon://error-symbolic?size=32);
        background-repeat: no-repeat;
        background-size: 150px;
        position: absolute;
        background-position-y: 40px;
        position: absolute;
        left: calc(50% - 45px);
        top: 120px;
    }

    ul#files.missing::after {
        content: '         Missing Directory';
        width: 200px;
        height: 200px;
        background: url(icon://image-missing-symbolic?size=32);
        background-repeat: no-repeat;
        background-size: 150px;
        position: absolute;
        background-position-y: 40px;
        position: absolute;
        left: calc(50% - 45px);
        top: 120px;
    }

    ul#files {
        --grid-size: calc(120px + 100px * var(--grid-scale, 0.35));

        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(var(--grid-size), 1fr));
        margin: 0;
        padding: calc(10px + var(--header-large-height)) 0;
    }

    ul#files > li {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-height: calc(var(--grid-size) - 20px);
        padding-bottom: 4px;
        padding: 10px;
        margin: 10px;
        border-radius: 10px;
        transition: filter 0.15s ease-in-out, background 0.24s ease-in-out;
    }

    ul#files > li.selected {
        background: var(--secondary-fg-semi-transparent);
    }

    ul#files > li > .image:hover {
        filter: brightness(117%);
    }

    ul#files > li > .image {
        max-width: 80%;
        min-height: calc(var(--grid-size) - 40px);
        max-height: calc(var(--grid-size) - 40px);
        object-fit: contain;
    }

    ul#files > li > span {
        text-align: center;
    }

    #action-wrapper {
        position: fixed;
        bottom: calc(4px + var(--window-drop-shadow-margin));
        left: var(--window-drop-shadow-margin);
        right: var(--window-drop-shadow-margin);
        height: 38px;
        opacity: 0.7;
        padding-left: 12px;
        -webkit-backdrop-filter: blur(8px);
        transition: height 0.25s ease-in-out, background 0.2s ease-in-out;
        color: black;
        background: transparent;
    }

    #action-wrapper.open {
        height: 220px;
        background: var(--primary-bg);
        bottom: 8px;
        border-top: 1px solid var(--color-offwhite);
    }

    #action-wrapper:not(.open.conversation) ~ #action-sibling #conversation,
    #action-wrapper:not(.open.actions) ~ #action-sibling #actions {
        display: none;
    }

    #action-wrapper.open ~ #action-sibling {
        height: 220px;
    }

    #action-wrapper.open.actions,
    #action-wrapper.open.actions ~ #action-sibling {
        height: 120px;
    }

    #actions {
        display: flex;
        overflow-x: auto;
    }

    #actions li {
        min-width: 150px;
        min-height: 40px;
        background: var(--secondary-bg);
        color: var(--secondary-fg);
        margin: 10px;
        padding: 0 10px;
        border-radius: 4px;
        cursor: pointer;
    }

    #actions li button {
        width: 100%;
        height: 100%;
        appearance: none;
        background: transparent;
        border: 0;
        cursor: pointer;
    }

    #action-wrapper ~ input#action {
        height: 34px;
        position: fixed;
        bottom: calc(5px + var(--window-drop-shadow-margin));
        left: calc(2px + var(--window-drop-shadow-margin));
        right: calc(2px + var(--window-drop-shadow-margin));
        padding-left: 120px;
        padding-right: 120px;
        text-align: center;
        z-index: 1000;
        background:
            radial-gradient(circle,
                rgba(255,255,255,0.74) 0%,
                rgba(255,255,255,0.76) 25%,
                rgba(255,255,255,0.83) 50%,
                rgba(255,255,255,0.88) 75%,
                rgba(255,255,255,0.92) 100%),

            linear-gradient(0deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.25) 75%,
                rgba(255,255,255,0.6) 100%),

            linear-gradient(180deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.25) 75%,
                rgba(255,255,255,0.6) 100%);

        border: 0.1px solid rebeccapurple;
        border-radius: 4px;
        outline: none;
        -webkit-appearance: none;
        -webkit-backdrop-filter: blur(8px) saturate(500%);
    }

    #action-sibling {
        position: fixed;
        bottom: var(--window-drop-shadow-margin);
        left: var(--window-drop-shadow-margin);
        right: var(--window-drop-shadow-margin);
        height: 42px;
        background: transparent;
        transition: height 0.25s ease-in-out;
        color: black;
    }

    #action-wrapper ~ #action-sibling ul#actions,
    #action-wrapper ~ #action-sibling ul#conversation {
        z-index: 100;
        transition: margin 0.4s ease-out, color 0.4s ease-in;
        color: rgba(0,0,0,0);
    }

    #action-wrapper ~ #action-sibling .overflow-wrapper {
        display: block;
        width: calc(100vw - var(--window-drop-shadow-margin) * 2);
        height: 220px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 2px;
    }

    #action-wrapper.open.actions ~ #action-sibling ul#actions,
    #action-wrapper.open.conversation ~ #action-sibling ul#conversation {
        color: rgba(0,0,0,1);
    }

    #action-wrapper ~ #action-suggestions {
        position: fixed;
        bottom: calc(8px + var(--window-drop-shadow-margin));
        left: calc(6px + var(--window-drop-shadow-margin));
        height: 32px;
        -webkit-appearance: none;
        background: var(--color-offwhite);
        border-bottom-left-radius: 4px;
        border-top-left-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
        z-index: 1001;
    }

    #action-wrapper ~ #action-submit {
        position: fixed;
        bottom: calc(8px + var(--window-drop-shadow-margin));
        right: calc(6px + var(--window-drop-shadow-margin));
        height: 32px;
        -webkit-appearance: none;
        background: var(--color-offwhite);
        border-bottom-right-radius: 4px;
        border-top-right-radius: 4px;
        border: 1px solid rgb(193, 193, 193);
        color: rgb(42, 42, 42);
        z-index: 1001;
    }

    #conversation {
        display: flex;
        flex-direction: column;
        padding-bottom: 30px;
    }

    #conversation li {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        max-width: 75%;
        background: var(--color-offwhite);
        border-radius: 10px;
        margin: 0;
        margin-bottom: 10px;
        line-height: 30px;
        padding: 0 10px;
        overflow-x: hidden;
    }

    #conversation li.ai {
        align-self: flex-end;
    }

    #conversation li.ai code pre {
        overflow-y: scroll;
    }

    #conversation li.ai code ~ button.evaluate {
        width: 100px;
        align-self: flex-end;
        padding: 10px;
        margin-bottom: 10px;
    }

    #conversation.locked li.ai {
        min-width: 310px;
    }

    #conversation.locked li.ai.lock p:after {
        overflow: hidden;
        display: inline-block;
        vertical-align: bottom;
        -webkit-animation: ellipsis steps(4,end) 900ms infinite;      
        animation: ellipsis steps(4,end) 900ms infinite;
        content: "\2026"; /* ascii code for the ellipsis character */
        width: 0px;
    }

    @keyframes ellipsis {
        to {
            width: 1.25em;    
        }
    }

    @-webkit-keyframes ellipsis {
        to {
            width: 1.25em;    
        }
    }

    input[type=range] {
        appearance: none;
        width: 100%;
        background: transparent;
        height: 2px;
        background: var(--secondary-fg);
        transition: background 0.25s ease-in-out;
    }

    input[type=range]:hover {
        background: var(--secondary-pop);
    }

    button#close-actions {
        appearance: none;
        width: 48px;
        height: 48px;
        position: absolute;
        top: 10px;
        right: 10px;
        background: url(icon://go-down-symbolic?size=32);
        background-repeat: no-repeat;
        background-position: center;
        background-size: 20px;
        border: 0;
        cursor: pointer;
    }

    #sign-up {
        --sign-up-width: 350px;

        display: flex;
        flex-direction: column;
        position: fixed;
        left: calc(50vw - (var(--sign-up-width) / 2));
        top: 75px;
        width: var(--sign-up-width);
        height: 420px;
        z-index: 1;
        padding: 10px;
        background: var(--secondary-bg);
        color: var(--secondary-fg);
        border-radius: 5px;
        max-height: calc(100vh - 180px);
        overflow: auto;
        overflow-x: hidden;
        box-shadow: 1px 1px 20px 2px var(--color-dim-gray);
    }

    #sign-up progress {
        display: none !important;
        appearance: none;
        position: absolute;
        width: calc(100%);
        top: 1px;
        left: 0px;
        right: 0px;
        height: 3px;
        background: var(--secondary-bg);
    }

    #sign-up progress.showing {
        display: block !important;
    }

    #sign-up progress::-webkit-progress-bar {
        background: var(--secondary-bg);
    }

    #sign-up progress::-webkit-progress-value {
        background: var(--secondary-pop);
        width: 150px;
        height: 3px;
        animation: progress-bar 1.4s ease-in-out infinite alternate;
    }

    @keyframes progress-bar {
        0% {
            transform: translateX(0px);
        }
        100% {
            transform: translateX(calc(var(--sign-up-width) - 140px));
        }
    }

    form.stripe-lookalike {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;

        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        line-height: 1.5;
        margin-top: 0em;
        box-sizing: border-box;
        border-width: 0;
        border-style: solid;
        border-color: #e2e8f0;
        position: relative;
        overflow-x: hidden;
        height: 100%;
    }

    form button[disabled] {
        filter: grayscale(1) opacity(0.3);
    }

    form.stripe-lookalike button:last-child {
        position: absolute;
        bottom: 0;
        text-decoration: underline;
        text-underline-offset: 20px;
        letter-spacing: 0px;
        transition: all 0.3s ease-in-out;
    }

    form.stripe-lookalike button:last-child:focus-visible,
    form.stripe-lookalike button:last-child:hover {
        outline: none !important;
        text-decoration: underline;
        text-underline-offset: 5px;
        letter-spacing: 1px;
    }

    form.stripe-lookalike .stripe-lookalike-entry {
        display: flex;
        margin-bottom: 0.75rem;
        margin-left: 0;
        margin-right: 0;
        flex-wrap: wrap;
        width: 100%;
        padding-left: 0;
        padding-right: 0;
    }

    form.stripe-lookalike .stripe-lookalike-entry label {
        display: block;
        letter-spacing: 0.025em;
        text-transform: uppercase;
        color: var(--secondary-fg);
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
    }

    form.stripe-lookalike .stripe-lookalike-entry input {
        display: block;
        width: 100%;
        padding: 0.75rem 0.5rem;
        margin-bottom: 0.75rem;
        line-height: 1.25;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        background-color: rgba(237, 242, 247, var(--bg-opacity, 1));
        appearance: none;
        overflow: visible;
        margin: 0 6px;
    }

    form.stripe-lookalike img[alt="Go back"] {
        position: absolute;
        height: 24px;
        width: 24px;
        cursor: pointer;
        padding: 6px;
        top: 14px;
        left: 0;
    }

    form.stripe-lookalike img[alt="Close"] {
        position: absolute;
        height: 24px;
        width: 24px;
        cursor: pointer;
        padding: 6px;
        right: 0;
        top: 14px;
    }

    form.stripe-lookalike h1 {
        -webkit-text-size-adjust: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
        border-width: 0;
        border-style: solid;
        border-color: #e2e8f0;
        font-weight: 700;
        font-size: 1.5rem;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
        text-align: center;
        --text-opacity: 1;
        color: rgba(237, 95, 116, var(--text-opacity));
    }

    form.stripe-lookalike button {
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
        border-width: 0;
        border-style: solid;
        border-color: #e2e8f0;
        font-family: inherit;
        font-size: 100%;
        margin: 0;
        overflow: visible;
        text-transform: none;
        background-image: none;
        cursor: pointer;
        line-height: inherit;
        -webkit-appearance: none;
        appearance: none;
        --bg-opacity: 1;
        background-color: rgba(237, 95, 116, var(--bg-opacity));
        border-radius: 0.375rem;
        font-weight: 300;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        padding-left: 1rem;
        padding-right: 1rem;
        --text-opacity: 1;
        color: rgba(255, 255, 255, var(--text-opacity));
        width: 100%;
    }

    form#sign-up-tos label {
        display: flex;
        align-items: center;
        margin-left: 10px;
        margin-bottom: 10px;
    }

    form#sign-up-tos input {
        width: 24px;
        height: 24px;
        margin-right: 10px;
    }

    form#sign-up-tos .sign-up-select-type {
        display: flex;
    }

    form#sign-up-tos .sign-up-select-type > div {
        border: 1px solid var(--primary-bg-semi-transparent);
        border-radius: 4px;
        margin: 6px;
        flex: 1;
        cursor: pointer;
        transition: border 0.3s ease-in-out;
    }

    form#sign-up-tos .sign-up-select-type > div.selected {
        border: 1px solid var(--secondary-pop);
    }

    form#sign-up-tos .sign-up-select-type > div > :is(h2, p) {
        text-align: center;
    }

    form#sign-up-tos .sign-up-select-type > div > h2 {
        transition: color 0.2s ease-in-out;
        margin-top: 0.75rem;
        margin-bottom: 0;
    }

    form#sign-up-tos .sign-up-select-type > div.selected > h2 {
        color: var(--secondary-pop);
    }

    form#sign-up-tos .sign-up-select-type > div > p {
        margin: 0.5rem;
        line-height: 1.5;
    }

    iframe#stripe-payment {
        border: none;
        height: 100%;
        width: 100%;
        background: var(--secondary-bg);
    }

    #account-information-aerome {
        overflow: hidden;
    }

    #account-information-aerome .unsubscribe {
        visibility: visible;
        position: absolute;
        bottom: 0;
        width: 100%;
    }

    #account-information-aerome .unsubscribe[inert] {
        visibility: hidden;
    }

    #account-information-aerome .unsubscribe > p {
        position: relative;
        bottom: 50px;
        transition: bottom 0.3s ease-in-out;
    }

    #account-information-aerome .unsubscribe[inert] > p {
        bottom: -50px;
    }

    #account-information-aerome .unsubscribe > button {
        position: absolute;
        left: 0;
        width: 48%;
        background: var(--secondary-bg);
        color: var(--secondary-pop);
        border: 0.3px solid var(--secondary-pop);
        transition: all 0.3s ease-in-out;
    }

    #account-information-aerome .unsubscribe[inert] > button {
        width: 100%;
    }

    #account-information-aerome .unsubscribe ~ button {
        transition: all 0.3s ease-in-out;
        right: 0;
    }

    #account-information-aerome .unsubscribe:not([inert]) ~ button {
        width: 48%;
    }

    #folder-context-menu {
        opacity: 0;
        pointer-events: none;

        background: var(--secondary-bg);
        color: var(--secondary-fg);

        position: fixed;
        top: 10px;
        left: 10px;

        display: flex;
        flex-direction: column;
        width: 220px;
        height: 200px;
        z-index: 10000000;
        line-height: 1.7;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 2px 2px 10px 2px var(--color-dim-gray);
    }

    #folder-context-menu:not([aria-hidden]) {
        opacity: 1;
        pointer-events: all;
    }

    #folder-context-menu .divider {
        width: 100%;
        height: 1px;
        background: var(--secondary-fg);
        margin: 4px 0;
    }

    #folder-context-menu ul {
        display: flex;
        flex-direction: column;
        flex: 1;
        padding: 0;
        margin: 0;
    }

    #folder-context-menu ul li {
        padding: 0 8px;
    }

    #folder-context-menu ul li.disabled {
        color: var(--secondary-fg-semi-transparent);
    }

    #folder-context-menu ul li:not(.disabled):hover {
        background: var(--primary-bg-semi-transparent);
        color: var(--primary-fg);
    }

    #folder-context-menu ul li span {
        cursor: default;
    }

    #dnd-visual-box {
        position: absolute;
        pointer-events: none;
        background: var(--secondary-pop-semi-transparent);
    }
</style>
<body>
    <div id="sign-up" style="display: none">
        <form class="stripe-lookalike" id="sign-up-tos">
            <h1>Welcome</h1>

            <p>Please read and agree to the <a href="https://aerome.net/tos.html" target="_blank">Terms of Service</a> and our <a href="https://aerome.net/privacy_policy.html" target="_blank">Privacy Policy</a> before continuing.</p>

            <label>
                <input type="checkbox" id="sign-up-tos-confirmation" required>
                I agree to the Terms of Service
            </label>

            <label>
                <input type="checkbox" id="sign-up-pp-confirmation" required>
                I have read the Privacy Policy
            </label>

            <div class="sign-up-select-type">
                <div class="sign-up-select-item" id="sign-up-select-byok">
                    <h2>Open AI Key</h2>
                    <p>Use a <br/> OpenAI <br /> key</p>
                </div>

                <div class="sign-up-select-item" id="sign-up-select-aerome-key">
                    <h2>Sign Up</h2>
                    <p>Get an Aerome account</p>
                </div>

                <div class="sign-up-select-item" id="sign-up-select-sign-in">
                    <h2>Sign In</h2>
                    <p>Existing Aerome account</p>
                </div>
            </div>

            <button type="submit">Continue</button>
        </form>

        <form class="stripe-lookalike" id="sign-up-byok" style="display: none;">
            <img
                src="icon://go-previous-symbolic?size=32"
                alt="Go back" />

            <h1>Use Open AI Directly</h1>

            <p>This option allows for you to use an Open AI key directly. If you use this option, your key is never sent to Aerome's servers.</p>

            <div class="stripe-lookalike-entry">
                <label for="sign-up-open-ai-key"> Key </label>
                <input name="key" id="sign-up-open-ai-key" />
            </div>

            <button type="submit">Save</button>
        </form>

        <form class="stripe-lookalike" id="sign-up-aerome" style="display: none;" aria-describedby="sign-up-progress-bar">
            <img
                src="icon://go-previous-symbolic?size=32"
                alt="Go back" />

            <h1>Create Account</h1>

            <div class="stripe-lookalike-entry">
                <label for="sign-up-email"> Email </label>
                <input type="email" name="email" id="sign-up-email" />
            </div>

            <div class="stripe-lookalike-entry">
                <label> Password: </label>
                <input type="password" name="password" />
            </div>

            <div class="stripe-lookalike-entry">
                <label> Confirm Password: </label>
                <input type="password" name="confirm_password" />
            </div>

            <button type="submit">Create Account</button>
        </form>

        <form class="stripe-lookalike" id="sign-in-aerome" style="display: none;" aria-describedby="sign-up-progress-bar">
            <img
                src="icon://go-previous-symbolic?size=32"
                alt="Go back" />

            <h1>Log In</h1>

            <div class="stripe-lookalike-entry">
                <label for="sign-up-email"> Email </label>
                <input type="email" name="email" id="sign-up-email" />
            </div>

            <div class="stripe-lookalike-entry">
                <label> Password: </label>
                <input type="password" name="password" />
            </div>

            <button type="submit">Sign Into Account</button>
        </form>

        <form class="stripe-lookalike" id="account-information-direct" style="display: none;" aria-describedby="sign-up-progress-bar">
            <img
                src="icon://window-close-symbolic?size=32"
                alt="Close" />

            <h1>Account</h1>
            <p>Your account is configured to use OpenAI directly. Aerome never see's any of your requests, and all billing is handled through Open AI.</p>

            <div class="stripe-lookalike-entry">
                <label for="account-information-direct-key"> Key </label>
                <input name="key" id="account-information-direct-key" />
            </div>

            <button>Log Out</button>
        </form>

        <form class="stripe-lookalike" id="account-information-aerome" style="display: none;" aria-describedby="sign-up-progress-bar">
            <img
                src="icon://window-close-symbolic?size=32"
                alt="Close" />

            <h1>Account</h1>

            <template>
                <p>Your last payment for $PRICE was on $LAST_PAYMENT_DATE</p>

                <div class="payment-current">
                    <p>Your next payment is due on $NEXT_PAYMENT_DATE</p>
                    <p>You can <a href="#unsubscribe" target="_blank">unsubscribe anytime</a></p>
                </div>

                <p class="payment-late">
                    You are currently overdue for a payment. You can
                    <a href="#update-payment-details" target="_blank">update your payment details here.</a> 
                </p>
            </template>

            <div class="account-information">
            </div>

            <div class="unsubscribe" aria-hidden=true inert=true>
                <p>
                    Are you sure you want to unsubscribe?
                </p>
                <button>No</button>
            </div>

            <button>Log Out</button>
        </form>

        <iframe id="stripe-payment" style="display: none;"></iframe>

        <progress id="sign-up-progress-bar" aria-label="Content loadingâ€¦"></progress>
    </div>

    <main>
        <header id="header">
            <div></div>
            <button id="back">Back</button>

            <div class="menu"
                onclick="event.target.matches('.tap-area, .menu') && this.firstElementChild.classList.toggle('showing')">
                <div class="content">
                    <form>
                        <h2>Scale</h2>
                        <input class="grid-scale" type="range" min=0 max=1 value=0.25 step=0.01
                            oninput="future.options.gridScale = this.value" />

                        <h2>Sort</h2>

                        <fieldset id="sort"
                            onchange="future.options.sort = this.querySelector(':checked').value">
                            <input type="radio" name="sort" value="a-z" />
                            <input type="radio" name="sort" value="z-a" />
                            <input type="radio" name="sort" value="date" />
                        </fieldset>

                        <label>
                            <input id="sort_folders_first" type="checkbox" name="folders_first"
                                onchange="future.options.sortFoldersFirst = this.checked" />
                            Folders first
                        </label>

                        <label>
                            <input id="sort_show_hidden" type="checkbox" name="show_hidden"
                                onchange="future.options.sortShowHidden = this.checked" />
                            Show hidden
                        </label>

                        <button id="show-account-information">
                            Account
                        </button>
                    </form>
                </div>

                <div class="tap-area" aria-hidden=true></div>
            </div>

            <div class="folder-wrapper">
                <h1 id="folder" contenteditable></h1>
            </div>

            <div class="controls">
                <img
                    id="control-minimize"
                    src="icon://window-minimize-symbolic?size=32"
                    alt="minimize application" />

                <img
                    id="control-maximize"
                    src="icon://window-maximize-symbolic?size=32"
                    alt="maximize application" />

                <img
                    id="control-close"
                    src="icon://window-close-symbolic?size=32"
                    alt="close application" />
            </div>
        </header>

        <div class="files-wrapper">
            <ul id="files"></ul>
            <div id="file-deep-look"></div>
            <div id="dnd-visual-box"></div>
        </div>

        <div class="spacer" aria-hidden=true></div>

        <div id="action-wrapper"></div>

        <input type="text" id="action" />

        <button id="action-suggestions">Suggestions</button>
        <button id="action-submit">Conversation</button>

        <div id="action-sibling">
            <div class="overflow-wrapper">
                <ul id="actions"></ul>
                <ul id="conversation"></ul>
            </div>
            <button id="close-actions"></button>
        </div>
    </main>

    <div id="folder-context-menu" inert aria-hidden=true>
        <ul tabindex="-1">
            <li><span>New Folder</span></li>
            <li><span>New Document</span></li>

            <div class="divider" aria-hidden=true></div>

            <li class="disabled"><span>Paste</span></li>
            <li><span>Select All</span></li>

            <div class="divider" aria-hidden="true"></div>

            <li><span>Inspect</span></li>
        </ul>
    </div>

    <div id="files-context-menu" inert aria-hidden=true></div>

    <script>
        const ACCOUNTS_SERVER = new URL('http://localhost:9008');

        window.future = {
            settings: {
                account: null
            },
            options: {
                get sort() {
                    return localStorage.sort?.toLowerCase() ?? 'a-z';
                },
                set sort(sort) {
                    sort = sort.toLowerCase();
                    localStorage.sort = sort;

                    document
                        .querySelector(`header #sort [value="${sort}"]`)
                        .checked = true;

                    notifyOptionsUpdate();
                },
                get sortFoldersFirst() {
                    switch (localStorage.sortFoldersFirst) {
                        case undefined:
                        case 'true': return true;
                        default: return false;
                    }
                },
                set sortFoldersFirst(sort) {
                    document.querySelector('header #sort_folders_first').checked = ('' + sort) === 'true';
                    localStorage.sortFoldersFirst = sort;
                    notifyOptionsUpdate();
                },
                get sortShowHidden() {
                    switch (localStorage.sortShowHidden) {
                        case 'true': return true;
                        default: return false;
                    }
                },
                set sortShowHidden(sort) {
                    document.querySelector('header #sort_show_hidden').checked = ('' + sort) === 'true';
                    localStorage.sortShowHidden = sort;
                    notifyOptionsUpdate();
                },
                get gridScale() {
                    const scale = +localStorage.gridScale;
                    return Number.isNaN(scale) ? 0.25 : scale;
                },
                set gridScale(scale) {
                    localStorage.gridScale = scale;
                    document.querySelector('header .grid-scale').value = scale;
                    document.getElementById('files').style.setProperty('--grid-scale', scale);
                }
            }
        };

        let lastUserMessage = '';
        let rpc = {
            invoke(arg) {
                window.ipc.postMessage(JSON.stringify(arg));
            }
        };

        document.getElementById('back').addEventListener('click', e => {
            rpc.invoke({ cmd: 'back', options: future.options });
            closeActionsBox();
        });

        document.getElementById('action').addEventListener('keypress', e => {
            if (e.key !== 'Enter') return;

            const input = e.target.closest('input');
            if (!input) return;

            const message = input.value;
            lastUserMessage = message;
            addConversationItem({ from: 'user', message });
            rpc.invoke({ cmd: 'communicate', message });
        });

        document.getElementById('action-submit').addEventListener('click', e => {
            const message = document.getElementById('action').value;
            if (!message) return;

            lastUserMessage = message;
            addConversationItem({ from: 'user', message });
            rpc.invoke({ cmd: 'communicate', message });
        });

        document.getElementById('files').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
            rpc.invoke({ cmd: 'forward', to: li.textContent, options: future.options });
        });

        document.getElementById('actions').addEventListener('click', e => {
            const li = e.target.closest('li');
            if (!li) return;
        });

        document.getElementById('action-suggestions').addEventListener('click', showActionSuggestions);

        window.setFileDeepLook = ({ name, path, openers }) => {
            // TODO: This is meant to have extended file attributes, large thumbnails,
            // and an "open with" view. Also it'll focus the model to operating on just
            // the one file. For now though, it serves as an error screen for a failure
            // to open a file when xdg-open can't find a proper application
            resetFolder(path);

            const isFileOpenError = !openers.length;
            if (isFileOpenError) {
                const el = document.getElementById('file-deep-look');
                el.innerHTML = '';
                el.classList.add('error');
            } else {
                el.classList.remove('error');
            }
        };

        function showActionSuggestions() {
            document.getElementById('action-wrapper').classList.add('open', 'actions');
            document.getElementById('action-wrapper').classList.remove('conversation');
        }

        function showConversation() {
            document.getElementById('action-wrapper').classList.add('open', 'conversation');
            document.getElementById('action-wrapper').classList.remove('actions');

            const scrollView = document.querySelector('#action-sibling .overflow-wrapper');
            scrollView.scrollTo(0, scrollView.scrollHeight);
        }

        let initialized = false;
        window.setFolder = ({ path, files }) => {
            const filesEl = document.getElementById('files');
            const folderEl = document.getElementById('folder');

            resetFolder(path);
            document.getElementById('file-deep-look').classList.remove('error');

            for (const file of files) {
                const li = document.createElement('li');
                const span = document.createElement('span');

                if (file.graphic) {
                    const graphic = document.createElement('img');
                    graphic.src = file.graphic;
                    graphic.className = 'image';
                    li.append(graphic);
                } else {
                    const dummy = document.createElement('div');
                    dummy.className = 'image';
                    li.append(dummy);
                }

                span.textContent = file.name;
                li.id = `file-${encodeFilenameToId(file.name)}`;
                li.append(span);

                filesEl.append(li);
            }

            if (!initialized) {
                initialized = true;
                rpc.invoke({ cmd: 'initialized' });
            }
        };

        window.updateThumbnail = ({ name, url }) => {
            const li = document.getElementById(`file-${encodeFilenameToId(name)}`);
            if (li) {
                li.querySelector('img').src = url;
            }
        };

        window.setMissingFolder = ({ path }) => {
            setFolder({ path, files: [] });
            document.getElementById('files').classList.add('missing');
        };

        window.setSuggestions = ({ path, actions = [] }) => {
            document.getElementById('actions').innerHTML = '';

            for (const action of actions) {
                const li = document.createElement('li');
                const button = document.createElement('button');

                button.textContent = action.description;
                li.append(button);

                button.addEventListener('click', event => {
                    lastUserMessage = null;
                    addConversationItem({
                        from: 'user',
                        message: action.question,
                        simulated: true
                    });
                    addConversationItem({
                        from: 'ai',
                        message: 'Sure, I can do that. Please review this script before evaluating it:',
                        code: action.code,
                        simulated: true
                    });
                });
                document.getElementById('actions').append(li);
            }
        };

        window.setSettings = settings => {
            future.settings = settings;
            if (!settings.account) {
                showSignUp();
            }
        };

        window.addConversationItem = ({ from, message, code, simulated }) => {
            const conversation = document.getElementById('conversation');

            if (from === 'user' && conversation.classList.contains('locked')) {
                return;
            }

            if (from === 'ai' && conversation.classList.contains('locked')) {
                conversation.classList.remove('locked');
                conversation.querySelector('li.lock').remove();
            }

            const li = document.createElement('li');
            const p = document.createElement('p');

            p.textContent = message;
            li.className = from;
            li.append(p);

            if (code) {
                const pre = document.createElement('pre');
                const codeEl = document.createElement('code');
                const evaluateButton = document.createElement('button');
                const evaluateCode = () => {
                    rpc.invoke({
                        cmd: 'evaluate',
                        item: {
                            from: 'user',
                            message: lastUserMessage,
                            code
                        },
                        options: future.options
                    });
                };

                codeEl.append(pre);
                pre.textContent = code;

                evaluateButton.className = 'evaluate';
                evaluateButton.textContent = 'Evaluate';
                evaluateButton.addEventListener('click', evaluateCode, { once: true });

                li.append(codeEl);
                li.append(evaluateButton);
            }

            conversation.append(li);
            showConversation();

            if (from === 'user' && !simulated) {
                document.getElementById('action').value = '';

                const item = addConversationItem({
                    from: 'ai',
                    message: 'Hold on a second while I process this'
                });
                item.classList.add('lock');
                conversation.classList.add('locked');
            }

            li.scrollIntoView({ behavior: 'smooth' });
            return li;
        };

        window.closeActionsBox = () => {
            document.getElementById('action-wrapper').classList.remove(
                'open',
                'actions',
                'conversation'
            );
        };

        function resetFolder(path) {
            const filesEl = document.getElementById('files');
            const folderEl = document.getElementById('folder');

            filesEl.classList.remove('missing');

            filesEl.innerHTML = '';
            folderEl.textContent = path;

            folderEl.blur();
            filesEl.focus();
        }

        function detailsAnimationOpen(details, e) {
            if (details.hasAttribute("open")) {
                e.preventDefault();
                details.classList.add("closing");
            }
        }

        function detailsAnimationEnd(details, e) {
            if (e.animationName === "close") {
                details.removeAttribute("open");
                details.classList.remove("closing");
            }
        }

        document.querySelector('.files-wrapper').addEventListener('scroll', e => {
            const offset = e.target.scrollTop;

            if (offset > 30) {
                header.classList.add('compressed');
                //header.style.setProperty('--header-height', '--header-height-comp');
            } else {
                header.classList.remove('compressed');
                //header.style.setProperty('--header-height', '20px');
            }
        });

        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('folder-wrapper') && e.buttons === 1) {
                rpc.invoke({ cmd: 'window', window: 'drag' });
                e.preventDefault();
                //e.detail === 2
                    //? window.ipc.postMessage()
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('folder-wrapper')) {
                window.ipc.postMessage('drag_window');
            }
        });

        document.getElementById('folder').addEventListener('keypress', e => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            rpc.invoke({ cmd: 'jump', to: e.target.textContent, options: future.options });
        });

        document.getElementById('close-actions').addEventListener('click', e => {
            closeActionsBox();
        });

        document.addEventListener('keydown', e => {
            switch (event.key) {
                case 'I': {
                    if (event.ctrlKey && event.shiftKey) {
                        rpc.invoke({ cmd: 'dev' });
                    }
                    break;
                }
                case 'l': {
                    if (event.ctrlKey) {
                        document.getElementById('folder').focus();
                        document.execCommand('selectAll', false, null);
                    }
                    break;
                }
                case 'ArrowLeft': {
                    if (event.altKey) {
                        rpc.invoke({ cmd: 'back', options: future.options });
                        closeActionsBox();
                    }
                    break;
                }
                case 'Escape': {
                    const action = e.target.closest('input#action');
                    if (action && action === document.activeElement) {
                        closeActionsBox();
                    }
                    break;
                }
                default: {
                    const hasFocusableElementParent =
                        e.target.closest('input') ||
                        e.target.closest('h1#folder');

                    if (!hasFocusableElementParent) {
                        const action = document.getElementById('action');
                        action.focus();

                    }
                }
            }
        });

        document.querySelector('main > .files-wrapper').addEventListener('scroll', e => {
            closeActionsBox();
        });

        document.getElementById('action').addEventListener('keydown', e => {
            if (document.getElementById('actions').children.length) {
                showActionSuggestions();
            }
        });

        document.getElementById('action-submit').addEventListener('click', e => {
            document.getElementById('action-wrapper').classList.remove('actions');
            document.getElementById('action-wrapper').classList.add('open', 'conversation');
        });

        document.getElementById('control-minimize').addEventListener('click', e => {
            rpc.invoke({ cmd: 'window', window: 'minimize' });
        });

        document.getElementById('control-maximize').addEventListener('click', e => {
            rpc.invoke({ cmd: 'window', window: 'maximize' });
        });

        document.getElementById('control-close').addEventListener('click', e => {
            rpc.invoke({ cmd: 'window', window: 'close' });
        });

        document.querySelector('#sign-up .sign-up-select-type').addEventListener('click', e => {
            const item = e.target.closest('.sign-up-select-item');
            if (!item) return;

            for (const child of e.currentTarget.children) {
                child.classList.remove('selected');
            }

            item.classList.add('selected');
        });

        document.getElementById('sign-up').addEventListener('click', e => {
            maybeNavigateBack(e);
            maybeClose(e);
        });

        function maybeClose(e) {
            const close = e.target.closest('img[alt="Close"]');
            if (!close) return;
            hideSignUp();
        }

        function maybeNavigateBack(e) {
            const back = e.target.closest('img[alt="Go back"]');
            if (!back) return;

            let previousPageId;
            switch (back.parentElement.id) {
                case 'sign-up-byok':
                case 'sign-in-aerome':
                case 'sign-up-aerome': previousPageId = 'sign-up-tos'; break;
            }
            if (!previousPageId) return;

            hideSLForm(back.parentElement);
            showSLForm(document.getElementById(previousPageId));
        }

        document.getElementById('sign-up-tos').addEventListener('submit', e => {
            e.preventDefault();

            if (!e.target.checkValidity()) {
                e.target.reportValidity();
                return;
            }

            hideSLForm(e.target);

            const showing = e.currentTarget.querySelector('.sign-up-select-type > .selected')?.id;
            switch (showing) {
                case 'sign-up-select-byok': {
                    showSLForm(document.getElementById('sign-up-byok'));
                    break;
                }

                case 'sign-up-select-sign-in': {
                    showSLForm(document.getElementById('sign-in-aerome'));
                    break;
                }

                default:
                case 'sign-up-select-aerome-key': {
                    showSLForm(document.getElementById('sign-up-aerome'));
                    break;
                }
            }
        });

        document.getElementById('sign-up-byok').addEventListener('submit', e => {
            e.preventDefault();

            const key = e.target.querySelector('#sign-up-open-ai-key').value;
            rpc.invoke({ cmd: 'settings', settings: { account: { direct: key } } });
            hideSignUp();
        });

        document.getElementById('sign-in-aerome').addEventListener('submit', async e => {
            e.preventDefault();

            // The submit button is used to report unknown server errors, we have to clear it hear
            // in order to allow for a retry
            e.target
                .querySelector('button[type="submit"]')
                .setCustomValidity('');

            showProgressBar(e.target);

            const formData = new FormData(e.target);
            const url = new URL('/auth/login', ACCOUNTS_SERVER);
            const params = new URLSearchParams(formData);
            const response = await (async function() {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        credentials: 'include',
                        body: params
                    });
                } catch (e) {
                    return { ok: false };
                }
            })();

            if (response.ok) {
                const aerome = await response.json();
                rpc.invoke({ cmd: 'settings', settings: { account: { aerome } } });
                hideSignUp();
            } else {
                const submitButton = e.target.querySelector('button[type="submit"]');

                submitButton.setCustomValidity('Unknown server error');
                e.target.reportValidity();

                let err;
                try {
                    err = await response.text();
                } catch (e) {}

                console.error(err || 'Unknown server error');
                setTimeout(() => {
                    submitButton.setCustomValidity('');
                }, 3000);
            }

            hideProgressBar(e.target);
        });

        document.getElementById('sign-up-aerome').addEventListener('change', e => {
            const passwordEl = e.currentTarget.querySelector('input[type="password"][name="password"]');
            const passwordConfirmEl = e.currentTarget.querySelector('input[type="password"][name="confirm_password"]');


            if (passwordEl.value !== passwordConfirmEl.value) {
                passwordEl.setCustomValidity('Passwords do not match');
            } else {
                passwordEl.setCustomValidity('');
            }

            if (e.target.matches('input[type="email"]')) {
                e.target.setCustomValidity('');
            }
        });

        function showProgressBar(affected) {
            const progressBar = document.getElementById('sign-up-progress-bar');

            progressBar.classList.add('showing');
            progressBar.removeAttribute('aria-hidden');
            affected.setAttribute('aria-busy', true);
        }

        function hideProgressBar(affected) {
            const progressBar = document.getElementById('sign-up-progress-bar');

            progressBar.classList.remove('showing');
            progressBar.setAttribute('aria-hidden', true);
            affected.removeAttribute('aria-busy');
        }

        document.getElementById('sign-up-aerome').addEventListener('submit', async e => {
            e.preventDefault();

            if (!e.target.checkValidity()) {
                e.target.reportValidity();
                return;
            }

            showProgressBar(e.target);

            const formData = new FormData(e.target);
            try {
                const url = new URL('/auth/signup', ACCOUNTS_SERVER);
                const params = new URLSearchParams(formData);
                const response = await fetch(url, {
                    method: 'POST',
                    credentials: 'include',
                    body: params
                });

                if (response.ok) {
                    const { key, email } = await response.json();
                    const paymentFrame = document.getElementById('stripe-payment');
                    paymentFrame.onload = () => {
                        hideSLForm(e.target);
                        showSLForm(paymentFrame);
                    };
                    const url = new URL(ACCOUNTS_SERVER);
                    url.search = new URLSearchParams([ [ 'key', key ], [ 'email', email ] ]);
                    paymentFrame.src = url;
                    const aerome = {
                        active: false,
                        email,
                        key
                    };
                    rpc.invoke({ cmd: 'settings', settings: { account: { aerome } } });
                } else {
                    const { error } = await response.json();
                    switch (error.type) {
                        case 'invalid_pass': {
                            e.target.querySelector('input[type="password"]').setCustomValidity(error.message);
                            break;
                        }
                        case 'invalid_email': {
                            e.target.querySelector('input[type="email"]').setCustomValidity(error.message);
                            break;
                        }
                    }
                    e.target.reportValidity();
                }
            } catch (error) {
                const submitButton = e.target.querySelector('button[type="submit"]');

                submitButton.setCustomValidity('Unknown server error');
                e.target.reportValidity();

                setTimeout(() => {
                    submitButton.setCustomValidity('');
                }, 3000);

                console.error(error);
            }

            hideProgressBar(e.target);
        });

        window.addEventListener('message', event => {
            if (!('' + ACCOUNTS_SERVER).startsWith(event.origin)) return;

            switch (event.data) {
                case 'success': {
                    hideSignUp();
                    const aerome = {
                        ...future.settings.account.aerome,
                        active: true
                    };
                    rpc.invoke({ cmd: 'settings', settings: { account: { aerome } } });
                    break;
                }
                case 'close': {
                    hideSignUp();
                    break;
                }
            }
        }, false);

        async function showAeromeAccountInformation({ email, key }) {
            const signUpFormsEl = document.getElementById('sign-up');
            const aeromeAccountInformationEl = document.getElementById('account-information-aerome');

            for (const child of signUpFormsEl.children) {
                child.style.display = 'none';
            }

            showSLForm(aeromeAccountInformationEl, 0);
            showProgressBar(aeromeAccountInformationEl);
            aeromeAccountInformationEl.style.display = 'block';

            const response = await (async function () {
                try {
                    return await fetch(new URL('/payment/subscription', ACCOUNTS_SERVER), {
                        headers: {
                            'aerome-email': email,
                            'aerome-key': key
                        }
                    });
                } catch (e) {
                    return { ok: false };
                }
            })();

            const transitionToPayment = () => {
                hideSLForm(aeromeAccountInformationEl);
                const paymentFrame = document.getElementById('stripe-payment');
                const url = new URL(ACCOUNTS_SERVER);
                url.search = new URLSearchParams([ [ 'key', key ], [ 'email', email ] ]);
                paymentFrame.src = url;
                paymentFrame.onload = () => {
                    showSLForm(paymentFrame);
                };
            };

            const createUnsubscribedElement = () => {
                const el = document.createElement('p');
                el.innerHTML =
                    'You are currently unsubscribed. To resubscribe update your ' +
                    '<a href="#update-payment-details">billing details</a>';
                el.querySelector('a[href="#update-payment-details"]').addEventListener('click', e => {
                    e.preventDefault();
                    transitionToPayment();
                });
                return el;
            }

            if (!response.ok) {
                aeromeAccountInformationEl.querySelector('.account-information').innerHTML =
                    'Error retrieving account information.';
            } else {
                const { allowance, paymentActive, paymentCurrent, paymentDate, price } = await response.json();
                let accountInfoEl = aeromeAccountInformationEl.querySelector('template')
                    .content.cloneNode(true);
                let lastPaymentEl = accountInfoEl.querySelector('p');

                if (!paymentActive) {
                    accountInfoEl = createUnsubscribedElement();
                } else if (paymentDate === null) {
                    lastPaymentEl.remove();
                } else {
                    const priceString = '' + price;
                    const dollarAmount = priceString.substr(0, priceString.length - 2);
                    const centsAmount = priceString.substr(priceString.length - 2, 2);
                    const formattedPrice = `$${dollarAmount}.${centsAmount}`;

                    const date = new Date(paymentDate);

                    lastPaymentEl.textContent = lastPaymentEl.textContent
                        .replace('$PRICE', formattedPrice)
                        .replace('$LAST_PAYMENT_DATE', date.toLocaleDateString())

                    if (paymentCurrent) {
                        accountInfoEl.querySelector('.payment-late').style.display = 'none';
                        accountInfoEl.querySelector('.payment-late').setAttribute('aria-hidden', true);
                        let nextPaymentDate = new Date(paymentDate);
                        nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
                        let nextPaymentEl = accountInfoEl.querySelector('.payment-current > p');
                        nextPaymentEl.textContent = nextPaymentEl.textContent
                            .replace('$NEXT_PAYMENT_DATE', nextPaymentDate.toLocaleDateString());
                    } else {
                        accountInfoEl.querySelector('.payment-current').style.display = 'none';
                        accountInfoEl.querySelector('.payment-current').setAttribute('aria-hidden', true);
                    }

                    accountInfoEl.querySelector('a[href="#update-payment-details"]').addEventListener('click', e => {
                        e.preventDefault();
                        transitionToPayment();
                    });

                    accountInfoEl.querySelector('a[href="#unsubscribe"]').addEventListener('click', e => {
                        e.preventDefault();

                        const form = e.target.closest('form');
                        const unsub = form.querySelector('.unsubscribe');
                        const primaryButton = form.querySelector('form > button:last-child');
                        const unsubscribe = async e => {
                            e.preventDefault();
                            e.stopPropagation();
                            showProgressBar(aeromeAccountInformationEl);

                            for (const button of form.querySelectorAll('button')) {
                                button.disabled = true;
                            }

                            try {
                                const response = await fetch(new URL('/payment/subscription', ACCOUNTS_SERVER), {
                                    method: 'DELETE',
                                    headers: {
                                        'aerome-email': email,
                                        'aerome-key': key
                                    }
                                });

                                hideProgressBar(aeromeAccountInformationEl);

                                if (!response.ok) {
                                    throw new Error();
                                }

                                for (const button of form.querySelectorAll('button')) {
                                    button.disabled = false;
                                }
                                primaryButton.removeEventListener('click', unsubscribe);
                                unsub.setAttribute('inert', true);
                                unsub.setAttribute('aria-hidden', true);
                                primaryButton.textContent = 'Log Out';

                                const accountInformation = aeromeAccountInformationEl
                                    .querySelector('.account-information');
                                accountInformation.innerHTML = '';
                                accountInformation.append(createUnsubscribedElement());

                            } catch (e) {
                                form.querySelector('.unsubscribe > p').innerHTML =
                                    'We encountered an error while unsubscribing your account. Please contact support '  +
                                    'at <a href="mailto:support@aerome.net">support@aerome.net</a>';
                            }
                        };
                        primaryButton.textContent = 'Yes';

                        primaryButton.addEventListener('click', unsubscribe);
                        unsub.removeAttribute('inert');
                        unsub.removeAttribute('aria-hidden');
                        unsub.querySelector('button').addEventListener('click', e => {
                            e.preventDefault();
                            unsub.setAttribute('inert', true);
                            unsub.setAttribute('aria-hidden', true);
                            primaryButton.textContent = 'Log Out';
                            primaryButton.removeEventListener('click', unsubscribe);
                        }, {
                            once: true
                        });
                    });
                }

                aeromeAccountInformationEl.querySelector('.account-information').innerHTML = '';
                aeromeAccountInformationEl.querySelector('.account-information').append(accountInfoEl);
            }
            hideProgressBar(aeromeAccountInformationEl);
            signUpFormsEl.style.display = 'block';
        }

        function showDirectAccountInformation() {
            const signUpFormsEl = document.getElementById('sign-up');
            const directAccountInformationEl = document.getElementById('account-information-direct');

            for (const child of signUpFormsEl.children) {
                child.style.display = 'none';
            }
            signUpFormsEl.style.display = 'block';
            showSLForm(directAccountInformationEl);
            directAccountInformationEl.style.display = 'block';
            directAccountInformationEl.querySelector('#account-information-direct-key').value =
                future.settings.account.direct;
        }

        document.getElementById('account-information-direct-key').addEventListener('input', e => {
            e.preventDefault();
            const direct = e.target.value;
            rpc.invoke({ cmd: 'settings', settings: { account: { direct } } });
        });

        document.getElementById('show-account-information').addEventListener('click', e => {
            e.preventDefault();
            document.getElementById('header')
                .querySelector('.menu > .content')
                .classList.remove('showing');

            const { aerome, direct } = future.settings.account;
            if (aerome) {
                showAeromeAccountInformation(aerome);
            } else {
                showDirectAccountInformation(direct);
            }
        });

        document.getElementById('account-information-direct').addEventListener('submit', logOut);
        document.getElementById('account-information-aerome').addEventListener('submit', logOut);

        function logOut(e) {
            e.preventDefault?.();
            rpc.invoke({ cmd: 'settings', settings: { account: null } });
            hideSLForm(e.target);
            showSLForm(document.getElementById('sign-up-tos'));
        }

        async function showSignUp(inertBackground = true) {
            document.getElementById('sign-up').style.display = 'block';

            if (inertBackground) {
                document.querySelector('main').classList.add('inert');
                document.querySelector('header .folder-wrapper #folder').setAttribute('inert', true);
                for (const child of document.getElementById('header').children) {
                    if (!child.matches('.folder-wrapper') && !child.matches('.controls')) {
                        child.setAttribute('inert', true);
                    }
                }

                for (const child of document.querySelector('main').children) {
                    if (!child.matches('header')) {
                        child.setAttribute('inert', true);
                    }
                }
            }
        }

        async function hideSignUp() {
            document.getElementById('sign-up').style.display = 'none';
            document.getElementById('stripe-payment').src = '';
            document.querySelector('main').classList.remove('inert');
            document.querySelector('header .folder-wrapper #folder').removeAttribute('inert');

            for (const child of document.getElementById('header').children) {
                if (!child.matches('.folder-wrapper') && !child.matches('.controls')) {
                    child.removeAttribute('inert');
                }
            }

            for (const child of document.querySelector('main').children) {
                if (!child.matches('header')) {
                    child.removeAttribute('inert');
                }
            }
        }

        async function hideSLForm(el) {
            const anim = el.animate([ { opacity: 1 }, { opacity: 0 }], {
                duration: 200,
                fill: 'forwards',
                easing: 'ease-out'
            });

            await anim.finished;
            el.style.display = 'none';
        }

        async function showSLForm(el, duration = 200) {
            const anim = el.animate([ { opacity: 0 }, { opacity: 1 }], {
                duration,
                fill: 'forwards',
                easing: 'ease-in'
            });

            el.style.display = 'block';
            await anim.finished;
        }

        window.addEventListener('contextmenu', e => {
            e.preventDefault();

            if (!e.target.closest('.files-wrapper')) {
                return
            }

            const menu = document.getElementById('folder-context-menu');
            const menuDimensions = menu.getBoundingClientRect();

            const x = Math.min(e.x, window.innerWidth - menuDimensions.width - 6);
            const y = Math.min(e.y, window.innerHeight - menuDimensions.height - 6);

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            menu.removeAttribute('aria-hidden');
            menu.removeAttribute('inert');
        });

        document.addEventListener('click', e => {
            if (e.target.closest('#folder-context-menu, #files-context-menu')) {
                return
            }

            const menu = document.getElementById('folder-context-menu');

            menu.setAttribute('aria-hidden', true);
            menu.setAttribute('inert', true);
        });

        document.getElementById('folder-context-menu').addEventListener('click', e => {
            // TODO
            switch (e.target.textContent) {
                case 'New Folder': break;
                case 'New Document': break;
                case 'Paste': break;
                case 'Select All': break;
                case 'Inspect': break;
            }
        });

        document.getElementById('files').addEventListener('pointerdown', e => {
            if (e.target.id !== 'files' && !e.target.matches('li')) return;

            const filesEl = e.target.closest('#files');
            const scrollEl = filesEl.parentElement;
            const boxEl = document.getElementById('dnd-visual-box');

            const startX = e.pageX;
            const startY = e.pageY;
            const startScroll = scrollEl.scrollTop;
            const startScrollHeight = scrollEl.scrollHeight;
            const startTop = e.pageY + startScroll;
            const childBoxSize = filesEl.children[0]?.getBoundingClientRect();

            if (!childBoxSize) {
                // Empty folder
                return;
            }
            const childStyle = getComputedStyle(filesEl.children[0]);
            const childWidth =
                parseFloat(childStyle.width) +
                (parseFloat(childStyle.paddingLeft) || 0) +
                (parseFloat(childStyle.paddingRight) || 0) +
                (parseFloat(childStyle.marginLeft) || 0) +
                (parseFloat(childStyle.marginRight) || 0);
            const childHeight =
                parseFloat(childStyle.height) +
                (parseFloat(childStyle.paddingTop) || 0) +
                (parseFloat(childStyle.paddingBottom) || 0) +
                (parseFloat(childStyle.marginTop) || 0) +
                (parseFloat(childStyle.marginBottom) || 0);

            let childRowSize = 0;
            for (const child of filesEl.children) {
                let rect = child.getBoundingClientRect();
                if (rect.top !== childBoxSize.top) {
                    break;
                }
                childRowSize += 1;
            }

            let scrollOffset = 0;
            let pageX = 0, pageY = 0;

            boxEl.style.left = `${e.pageX}px`;
            boxEl.style.top = `${e.pageY + startScroll}px`;
            boxEl.style.width = '0px';
            boxEl.style.height = '0px';
            boxEl.style.opacity = 1;
            const intervalId = setInterval(highlightIntersections, 100);

            filesEl.setPointerCapture(e.pointerId);
            filesEl.addEventListener('pointermove', onMove);
            filesEl.addEventListener('pointerup', onUp);
            scrollEl.addEventListener('scroll', onScroll);

            function highlightIntersections() {
                const x1 = parseInt(boxEl.style.left);
                const x2 = parseInt(boxEl.style.width) + x1;

                const rowX1Offset = Math.floor(x1 / childWidth);
                const rowX2Offset = Math.floor(x2 / childWidth);

                const y1 = parseInt(boxEl.style.top);
                const y2 = parseInt(boxEl.style.height) + y1;
                const boxTotalHeight = childBoxSize.height + childBoxSize.top;

                const rowY1Offset = Math.floor(y1 / childHeight);
                const rowY2Offset = Math.floor(y2 / childHeight) + 1;

                const startOffset = rowY1Offset * childRowSize;
                const endOffset = rowY2Offset * childRowSize;

                for (let i = 0; i < filesEl.children.length; i++) {
                    const isWithinBoxStart = i % childRowSize >= rowX1Offset;
                    const isWithinBoxEnd = i % childRowSize <= rowX2Offset;

                    if (isWithinBoxStart && isWithinBoxEnd && i >= startOffset && i < endOffset) {
                        filesEl.children[i].classList.add('selected');
                    } else {
                        filesEl.children[i].classList.remove('selected');
                    }
                }
            }

            function moveBox(cancel) {
                const differenceX = pageX - startX;
                const differenceY = pageY - startY + scrollOffset;

                if (differenceY > 0 && startTop + differenceY + 20 > startScrollHeight) {
                    cancel();
                    return;
                }

                if (differenceX < 0) {
                    boxEl.style.left = pageX + 'px';
                }

                if (differenceY < 0) {
                    boxEl.style.top = scrollOffset >= 0
                        ? `${pageY + startScroll}px`
                        : `${pageY + startScroll + scrollOffset}px`;
                }
                boxEl.style.width = `${Math.abs(differenceX)}px`;
                boxEl.style.height = `${Math.abs(differenceY)}px`;
            }

            function onScroll(e) {
                scrollOffset = scrollEl.scrollTop - startScroll;
                moveBox(() => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            }

            function onMove(e) {
                pageX = e.pageX;
                pageY = e.pageY;
                moveBox(() => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            }

            function onUp(e) {
                boxEl.style.opacity = 0;
                filesEl.releasePointerCapture(e.pointerId);
                filesEl.removeEventListener('pointermove', onMove);
                filesEl.removeEventListener('pointerup', onUp);
                scrollEl.removeEventListener('scroll', onScroll);
                scrollEl.scrollTo({ left: 0, behavior: 'smooth' });
                clearInterval(intervalId);
            }
        });

        const debounce = (delay, cb) => {
            let id;
            return (...args) => {
                if (id) clearTimeout(id);
                id = setTimeout(() => {
                    cb(...args);
                    id = null;
                }, delay);
            };
        };

        const notifyOptionsUpdate = debounce(250, () => {
            rpc.invoke({ cmd: 'options', options: future.options });
        });

        function encodeFilenameToId(name) {
            return MD5(unescape(encodeURIComponent(name)));
        }

        Object.assign(future.options, future.options);
        function MD5(d){var r = M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}
    </script>
</body>
